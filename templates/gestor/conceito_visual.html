<!-- templates/gestor/conceito_visual.html - VERSÃO 3 SIMPLIFICADA -->
{% extends 'gestor/base_gestor.html' %}
{% load formatadores %}

{% block title %}Conceito Visual - {{ projeto.nome }} | Portal do Gestor{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <!-- CABEÇALHO -->
  <div class="card shadow mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <i class="fas fa-paint-brush me-2"></i>
        <h4 class="mb-0">Conceito Visual - {{ projeto.nome }}</h4>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-success" onclick="executarProcessoCompleto()">
          <i class="fas fa-play-circle me-1"></i> Executar Tudo
        </button>
        <a href="{% url 'gestor:projeto_detail' pk=projeto.id %}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- COLUNA ESQUERDA -->
    <div class="col-md-8">
      
      <!-- ETAPA 1: ANÁLISE DE ESBOÇO -->
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <span class="badge bg-white text-primary rounded-circle me-2">1</span>
            Análise do Esboço
          </h5>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-light text-dark" id="status-badge-1">Não Executado</span>
            <button class="btn btn-light btn-sm" onclick="executarEtapa1()" id="btn-etapa1">
              <i class="fas fa-play text-primary me-1"></i> Executar
            </button>
          </div>
        </div>
        <div class="card-body">
          <p class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Extrai a estrutura espacial do esboço: áreas, dimensões e layout.
          </p>
          
          {% if arquivos_planta %}
          <div class="mb-3">
            <p class="fw-bold">{{ arquivos_planta|length }} esboço(s) de planta disponível(is)</p>
          </div>
          {% else %}
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Nenhum esboço de planta disponível. Faça upload no briefing primeiro.
          </div>
          {% endif %}

          <!-- Resultado -->
          <div class="result-container d-none" id="result-1">
            <div class="alert alert-success">
              <i class="fas fa-check-circle me-2"></i> Layout extraído com sucesso
            </div>
            
            <div class="row">
              <div class="col-md-8">
                <h6 class="fw-bold">Layout Identificado:</h6>
                <pre class="bg-light p-3 rounded small" id="layout-json" style="max-height: 300px; overflow-y: auto;"></pre>
              </div>
              <div class="col-md-4">
                <div id="arquivo-info-1" class="d-none">
                  <h6 class="fw-bold">Arquivo Analisado:</h6>
                  <div class="text-center">
                    <img id="esboco-thumb" src="" class="img-fluid rounded shadow-sm mb-2" style="max-height:200px;">
                    <p class="small text-muted mb-0" id="esboco-nome"></p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Loading -->
          <div class="text-center d-none" id="loading-1">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Processando...</span>
            </div>
            <p class="mt-2 text-muted">Analisando esboço...</p>
          </div>
        </div>
      </div>

      <!-- ETAPA 2: ANÁLISE DE REFERÊNCIAS -->
      <div class="card shadow mb-4">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <span class="badge bg-white text-info rounded-circle me-2">2</span>
            Análise de Referências Visuais
          </h5>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-light text-dark" id="status-badge-2">Não Executado</span>
            <button class="btn btn-light btn-sm" onclick="executarEtapa2()" id="btn-etapa2">
              <i class="fas fa-play text-info me-1"></i> Executar
            </button>
          </div>
        </div>
        <div class="card-body">
          <p class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Extrai paleta de cores, estilos e inspirações das imagens de referência.
          </p>
          
          {% if arquivos_referencia %}
          <div class="mb-3">
            <p class="fw-bold">{{ arquivos_referencia|length }} imagem(ns) de referência disponível(is)</p>
          </div>
          {% else %}
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Nenhuma imagem de referência disponível. Faça upload no briefing primeiro.
          </div>
          {% endif %}

          <!-- Resultado -->
          <div class="result-container d-none" id="result-2">
            <div class="alert alert-success">
              <i class="fas fa-check-circle me-2"></i> Inspirações extraídas com sucesso
            </div>
            
            <h6 class="fw-bold">Análise Visual:</h6>
            <pre class="bg-light p-3 rounded small" id="inspiracoes-json" style="max-height: 300px; overflow-y: auto;"></pre>
            
            <!-- Preview de cores -->
            <div id="cores-preview" class="mt-3 d-none">
              <h6 class="fw-bold">Paleta de Cores:</h6>
              <div class="d-flex gap-2" id="cores-container"></div>
            </div>
          </div>

          <!-- Loading -->
          <div class="text-center d-none" id="loading-2">
            <div class="spinner-border text-info" role="status">
              <span class="visually-hidden">Processando...</span>
            </div>
            <p class="mt-2 text-muted">Analisando referências...</p>
          </div>
        </div>
      </div>

      <!-- ETAPA 3: GERAÇÃO DO CONCEITO VISUAL (SIMPLIFICADA) -->
      <div class="card shadow mb-4">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <span class="badge bg-white text-success rounded-circle me-2">3</span>
            Geração do Conceito Visual
          </h5>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-light text-dark" id="status-badge-3">Não Executado</span>
            <button class="btn btn-light btn-sm" onclick="executarEtapa3()" id="btn-etapa3">
              <i class="fas fa-magic text-success me-1"></i> Gerar Imagem
            </button>
          </div>
        </div>
        <div class="card-body">
          <p class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Gera o conceito visual usando os dados das etapas anteriores.
          </p>
          
          <!-- Pré-requisitos -->
          <div class="alert alert-info" id="prerequisitos-3">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>Pré-requisitos:</strong> Execute as Etapas 1 e 2 primeiro para gerar o prompt automaticamente.
          </div>

          <!-- Editor de Prompt -->
          <div class="mb-4 d-none" id="prompt-section">
            <label class="form-label fw-bold">
              <i class="fas fa-edit me-1"></i> Prompt de Geração:
            </label>
            <textarea class="form-control font-monospace" id="prompt-editor" rows="8" 
                      placeholder="O prompt será gerado automaticamente com base nas análises anteriores..."></textarea>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Edite o prompt se desejar ajustar a geração da imagem
              </small>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="resetarPrompt()">
                  <i class="fas fa-undo me-1"></i> Resetar Prompt
                </button>
                <!-- NOVO BOTÃO: Regenerar com prompt editado -->
                <button class="btn btn-sm btn-warning d-none" id="btn-regenerar-prompt" onclick="regenerarComPromptEditado()">
                  <i class="fas fa-sync me-1"></i> Regenerar com Este Prompt
                </button>
              </div>
            </div>
          </div>

          <!-- Resultado da Imagem -->
          <div class="result-container d-none" id="result-3">
            <div class="alert alert-success mb-3">
              <i class="fas fa-check-circle me-2"></i> <span id="msg-sucesso-geracao">Conceito visual gerado com sucesso!</span>
            </div>
            
            <!-- Imagem Gerada -->
            <div class="text-center mb-4">
              <img id="imagem-conceito" src="" alt="Conceito Visual" 
                   class="img-fluid rounded shadow" style="max-height:600px;">
            </div>
            
            <!-- Ações -->
            <div class="d-flex justify-content-center gap-3 mb-4">
              <a id="link-download" href="" download class="btn btn-success">
                <i class="fas fa-download me-2"></i> Baixar Imagem
              </a>
              <button class="btn btn-primary" onclick="mostrarPromptUsado()">
                <i class="fas fa-code me-2"></i> Ver Prompt Usado
              </button>
              <button class="btn btn-outline-warning" onclick="editarPromptParaRegenerar()">
                <i class="fas fa-edit me-2"></i> Editar Prompt
              </button>
            </div>
            
            <!-- Modal para mostrar o prompt usado -->
            <div id="prompt-usado-container" class="d-none">
              <div class="card border-secondary">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                  <span class="fw-bold">Prompt Utilizado</span>
                  <button class="btn btn-sm btn-outline-secondary" onclick="copiarPrompt()">
                    <i class="fas fa-copy me-1"></i> Copiar
                  </button>
                </div>
                <div class="card-body">
                  <pre class="mb-0" id="prompt-usado-display" style="white-space: pre-wrap;"></pre>
                </div>
              </div>
            </div>
          </div>

          <!-- Loading -->
          <div class="text-center d-none" id="loading-3">
            <div class="spinner-border text-success" role="status">
              <span class="visually-hidden">Processando...</span>
            </div>
            <p class="mt-2 text-muted" id="loading-3-msg">Gerando conceito visual... Isso pode levar alguns segundos.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- COLUNA DIREITA -->
    <div class="col-md-4">
      <!-- Status Geral -->
      <div class="card shadow mb-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0"><i class="fas fa-tasks me-2"></i> Status do Processo</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span><i class="fas fa-map me-1 text-primary"></i> Layout</span>
              <span id="status-1" class="badge bg-secondary">Pendente</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span><i class="fas fa-palette me-1 text-info"></i> Inspirações</span>
              <span id="status-2" class="badge bg-secondary">Pendente</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <span><i class="fas fa-image me-1 text-success"></i> Conceito</span>
              <span id="status-3" class="badge bg-secondary">Pendente</span>
            </div>
          </div>
          
          <hr>
          
          <!-- Indicadores de dados salvos -->
          <div class="text-center">
            <div class="d-none" id="dados-salvos-info">
              <small class="text-success">
                <i class="fas fa-database me-1"></i> Dados recuperados do banco
              </small>
            </div>
            <small class="text-muted d-block mt-2">
              Última atualização: <span id="ultima-atualizacao">-</span>
            </small>
          </div>
        </div>
      </div>

      <!-- Dados do Projeto -->
      <div class="card shadow mb-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i> Dados do Projeto</h5>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-5">Empresa:</dt>
            <dd class="col-7">{{ projeto.empresa.nome }}</dd>
            
            {% if briefing %}
              <dt class="col-5">Dimensões:</dt>
              <dd class="col-7">
                {% if briefing.medida_frente %}
                  {% if briefing.medida_lateral_esquerda %}
                    {{ briefing.medida_frente }}m × {{ briefing.medida_lateral_esquerda }}m
                  {% elif briefing.medida_lateral_direita %}
                    {{ briefing.medida_frente }}m × {{ briefing.medida_lateral_direita }}m
                  {% else %}
                    {{ briefing.medida_frente }}m (frente)
                  {% endif %}
                {% else %}
                  <span class="text-muted">Não informado</span>
                {% endif %}
              </dd>
              
              <dt class="col-5">Área:</dt>
              <dd class="col-7">
                {% if briefing.area_estande %}
                  {{ briefing.area_estande }}m²
                {% else %}
                  <span class="text-muted">Não informado</span>
                {% endif %}
              </dd>
              
              <dt class="col-5">Tipo Stand:</dt>
              <dd class="col-7">{{ briefing.get_tipo_stand_display|default:"Não informado" }}</dd>
            {% endif %}
          </dl>
        </div>
      </div>

      <!-- Arquivos Disponíveis -->
      <div class="card shadow">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0"><i class="fas fa-folder-open me-2"></i> Arquivos Disponíveis</h5>
        </div>
        <div class="card-body">
          <h6 class="text-primary">
            <i class="fas fa-map me-1"></i> Esboços ({{ arquivos_planta|length }})
          </h6>
          {% if arquivos_planta %}
            <ul class="list-unstyled small mb-3">
              {% for arquivo in arquivos_planta %}
                <li class="mb-1">
                  <i class="fas fa-file-image text-muted me-1"></i>
                  {{ arquivo.nome }}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted small mb-3">Nenhum esboço disponível</p>
          {% endif %}
          
          <h6 class="text-info">
            <i class="fas fa-palette me-1"></i> Referências ({{ arquivos_referencia|length }})
          </h6>
          {% if arquivos_referencia %}
            <ul class="list-unstyled small mb-0">
              {% for arquivo in arquivos_referencia %}
                <li class="mb-1">
                  <i class="fas fa-image text-muted me-1"></i>
                  {{ arquivo.nome }}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted small mb-0">Nenhuma referência disponível</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Script tags para dados JSON salvos -->
{% if projeto.layout_identificado %}
{{ projeto.layout_identificado|json_script:"layout-data" }}
{% endif %}
{% if projeto.inspiracoes_visuais %}
{{ projeto.inspiracoes_visuais|json_script:"inspiracoes-data" }}
{% endif %}

<script>
// === Estado Global ===
let resultadoEtapa1 = null;
let resultadoEtapa2 = null;
let resultadoEtapa3 = null;
let promptOriginal = '';  // Guarda o prompt gerado automaticamente
let promptAtualUsado = ''; // Guarda o prompt que foi usado na última geração

// === CSRF Token ===
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
  return match ? decodeURIComponent(match[1]) : '';
}
const CSRF_TOKEN = getCookie('csrftoken');

// === ETAPA 1: Análise de Esboço ===
async function executarEtapa1() {
  // UI
  document.getElementById('btn-etapa1').disabled = true;
  document.getElementById('loading-1').classList.remove('d-none');
  document.getElementById('result-1').classList.add('d-none');
  atualizarStatus(1, 'executando');
  
  try {
    const response = await fetch(`/gestor/projeto/{{ projeto.id }}/conceito-visual/etapa1/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': CSRF_TOKEN,
        'Content-Type': 'application/json'
      },
      body: '{}'
    });
    
    const data = await response.json();
    
    if (data.sucesso) {
      resultadoEtapa1 = data;
      
      // Mostrar resultado
      document.getElementById('layout-json').textContent = JSON.stringify(data.layout, null, 2);
      
      if (data.arquivo) {
        if (data.arquivo.nome) {
          document.getElementById('esboco-nome').textContent = data.arquivo.nome;
        }
        if (data.arquivo.url) {
          document.getElementById('esboco-thumb').src = data.arquivo.url;
        }
        document.getElementById('arquivo-info-1').classList.remove('d-none');
      }
      
      document.getElementById('result-1').classList.remove('d-none');
      atualizarStatus(1, 'concluido');
      verificarPreRequisitos();
      
    } else {
      alert(`Erro na Etapa 1: ${data.erro}`);
      atualizarStatus(1, 'erro');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao executar Etapa 1');
    atualizarStatus(1, 'erro');
  } finally {
    document.getElementById('btn-etapa1').disabled = false;
    document.getElementById('loading-1').classList.add('d-none');
  }
}

// === ETAPA 2: Análise de Referências ===
async function executarEtapa2() {
  // UI
  document.getElementById('btn-etapa2').disabled = true;
  document.getElementById('loading-2').classList.remove('d-none');
  document.getElementById('result-2').classList.add('d-none');
  atualizarStatus(2, 'executando');
  
  try {
    const response = await fetch(`/gestor/projeto/{{ projeto.id }}/conceito-visual/etapa2/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': CSRF_TOKEN,
        'Content-Type': 'application/json'
      },
      body: '{}'
    });
    
    const data = await response.json();
    
    if (data.sucesso) {
      resultadoEtapa2 = data;
      
      // Mostrar resultado
      document.getElementById('inspiracoes-json').textContent = JSON.stringify(data.inspiracoes, null, 2);
      
      // Mostrar preview de cores se existir
      if (data.inspiracoes.cores_predominantes) {
        mostrarPreviewCores(data.inspiracoes.cores_predominantes);
      }
      
      document.getElementById('result-2').classList.remove('d-none');
      atualizarStatus(2, 'concluido');
      verificarPreRequisitos();
      
    } else {
      alert(`Erro na Etapa 2: ${data.erro}`);
      atualizarStatus(2, 'erro');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao executar Etapa 2');
    atualizarStatus(2, 'erro');
  } finally {
    document.getElementById('btn-etapa2').disabled = false;
    document.getElementById('loading-2').classList.add('d-none');
  }
}

// === ETAPA 3: Geração do Conceito (SIMPLIFICADA) ===
async function executarEtapa3(usarPromptEditado = false) {
  // Verificar pré-requisitos
  if (!resultadoEtapa1 || !resultadoEtapa2) {
    alert('Execute as Etapas 1 e 2 primeiro!');
    return;
  }
  
  // Pegar o prompt do editor (pode ter sido editado pelo usuário)
  const promptAtual = document.getElementById('prompt-editor').value.trim();
  
  // UI
  document.getElementById('btn-etapa3').disabled = true;
  document.getElementById('btn-regenerar-prompt').disabled = true;
  document.getElementById('loading-3').classList.remove('d-none');
  document.getElementById('result-3').classList.add('d-none');
  document.getElementById('prompt-usado-container').classList.add('d-none');
  
  // Atualizar mensagem de loading baseado no contexto
  if (usarPromptEditado && promptAtual) {
    document.getElementById('loading-3-msg').textContent = 'Regenerando imagem com prompt editado...';
    document.getElementById('msg-sucesso-geracao').textContent = 'Imagem regenerada com sucesso usando o prompt editado!';
  } else {
    document.getElementById('loading-3-msg').textContent = 'Gerando conceito visual... Isso pode levar alguns segundos.';
    document.getElementById('msg-sucesso-geracao').textContent = 'Conceito visual gerado com sucesso!';
  }
  
  atualizarStatus(3, 'executando');
  
  try {
    // Se há prompt no editor, enviar ele. Senão, deixar o backend gerar
    const body = promptAtual ? JSON.stringify({ prompt: promptAtual }) : '{}';
    
    const response = await fetch(`/gestor/projeto/{{ projeto.id }}/conceito-visual/etapa3/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': CSRF_TOKEN,
        'Content-Type': 'application/json'
      },
      body: body
    });
    
    const data = await response.json();
    
    if (data.sucesso) {
      resultadoEtapa3 = data;
      
      // Mostrar imagem
      document.getElementById('imagem-conceito').src = data.image_url;
      document.getElementById('link-download').href = data.download_url || data.image_url;
      
      // Guardar o prompt usado
      promptAtualUsado = data.prompt_usado;
      document.getElementById('prompt-usado-display').textContent = data.prompt_usado;
      
      // Se não tinha prompt no editor (foi gerado automaticamente), mostrar no editor
      if (!promptAtual && data.prompt_usado) {
        document.getElementById('prompt-editor').value = data.prompt_usado;
        promptOriginal = data.prompt_usado;  // Guardar o original
      }
      
      document.getElementById('result-3').classList.remove('d-none');
      atualizarStatus(3, 'concluido');
      
      // Detectar mudanças no prompt para mostrar botão de regenerar
      monitorarMudancasPrompt();
      
    } else {
      alert(`Erro na Etapa 3: ${data.erro || 'Erro desconhecido'}`);
      atualizarStatus(3, 'erro');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao gerar conceito visual');
    atualizarStatus(3, 'erro');
  } finally {
    document.getElementById('btn-etapa3').disabled = false;
    document.getElementById('btn-regenerar-prompt').disabled = false;
    document.getElementById('loading-3').classList.add('d-none');
  }
}

// === Função para regenerar com prompt editado ===
function regenerarComPromptEditado() {
  const promptEditado = document.getElementById('prompt-editor').value.trim();
  
  if (!promptEditado) {
    alert('O prompt não pode estar vazio!');
    return;
  }
  
  if (promptEditado === promptAtualUsado) {
    alert('O prompt não foi modificado. Edite o prompt antes de regenerar.');
    return;
  }
  
  if (confirm('Regenerar a imagem com o prompt editado?')) {
    executarEtapa3(true);
  }
}

// === Monitorar mudanças no prompt ===
function monitorarMudancasPrompt() {
  const editor = document.getElementById('prompt-editor');
  const btnRegenerar = document.getElementById('btn-regenerar-prompt');
  
  // Adicionar evento de input ao editor se ainda não tiver
  if (!editor.dataset.listenerAdded) {
    editor.addEventListener('input', function() {
      const promptAtual = this.value.trim();
      
      // Mostrar botão de regenerar se o prompt foi modificado
      if (promptAtual && promptAtual !== promptAtualUsado) {
        btnRegenerar.classList.remove('d-none');
        btnRegenerar.classList.add('pulse-animation'); // Adicionar animação para chamar atenção
      } else {
        btnRegenerar.classList.add('d-none');
      }
    });
    editor.dataset.listenerAdded = 'true';
  }
}

// === Funções de Interface ===
function mostrarPromptUsado() {
  const container = document.getElementById('prompt-usado-container');
  container.classList.toggle('d-none');
}

function copiarPrompt() {
  const prompt = document.getElementById('prompt-usado-display').textContent;
  navigator.clipboard.writeText(prompt).then(() => {
    alert('Prompt copiado para a área de transferência!');
  });
}

function resetarPrompt() {
  if (promptOriginal) {
    document.getElementById('prompt-editor').value = promptOriginal;
    document.getElementById('btn-regenerar-prompt').classList.add('d-none');
  } else {
    alert('Execute as etapas 1 e 2 primeiro para gerar o prompt automático.');
  }
}

function editarPromptParaRegenerar() {
  // Rolar para o editor de prompt
  document.getElementById('prompt-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
  
  // Focar no editor
  setTimeout(() => {
    const editor = document.getElementById('prompt-editor');
    editor.focus();
    editor.setSelectionRange(editor.value.length, editor.value.length);
    
    // Destacar o botão de regenerar se prompt foi modificado
    const promptAtual = editor.value.trim();
    if (promptAtual && promptAtual !== promptAtualUsado) {
      document.getElementById('btn-regenerar-prompt').classList.remove('d-none');
    }
  }, 500);
}

// === Processo Completo ===
async function executarProcessoCompleto() {
  if (!confirm('Executar todas as etapas em sequência?')) return;
  
  // Etapa 1
  if (!resultadoEtapa1) {
    await executarEtapa1();
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
  
  // Etapa 2
  if (!resultadoEtapa2) {
    await executarEtapa2();
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
  
  // Etapa 3
  if (resultadoEtapa1 && resultadoEtapa2) {
    await executarEtapa3();
  }
}

// === Funções Auxiliares ===
function atualizarStatus(etapa, status) {
  const badge = document.getElementById(`status-${etapa}`);
  const statusBadge = document.getElementById(`status-badge-${etapa}`);
  
  const configs = {
    'pendente': { class: 'bg-secondary', text: 'Pendente' },
    'executando': { class: 'bg-warning', text: 'Executando' },
    'concluido': { class: 'bg-success', text: 'Concluído' },
    'erro': { class: 'bg-danger', text: 'Erro' },
    'salvo': { class: 'bg-info', text: 'Dados Salvos' }
  };
  
  const config = configs[status] || configs['pendente'];
  
  [badge, statusBadge].forEach(el => {
    if (el) {
      el.className = `badge ${config.class}`;
      el.textContent = config.text;
    }
  });
  
  // Atualizar timestamp
  document.getElementById('ultima-atualizacao').textContent = new Date().toLocaleTimeString();
}

function verificarPreRequisitos() {
  // Verificar se pode executar Etapa 3
  if (resultadoEtapa1 && resultadoEtapa2) {
    document.getElementById('prerequisitos-3').classList.add('d-none');
    document.getElementById('prompt-section').classList.remove('d-none');
    
    // Deixar o campo vazio - será preenchido quando gerar
    if (!document.getElementById('prompt-editor').value) {
      document.getElementById('prompt-editor').placeholder = "Clique em 'Gerar Imagem' para criar o prompt automaticamente...";
    }
    
    // Adicionar monitor de mudanças
    monitorarMudancasPrompt();
  }
}

function mostrarPreviewCores(cores) {
  if (!cores || !Array.isArray(cores)) return;
  
  const container = document.getElementById('cores-container');
  container.innerHTML = '';
  
  cores.forEach(cor => {
    if (cor.hex) {
      const div = document.createElement('div');
      div.style.width = '60px';
      div.style.height = '60px';
      div.style.backgroundColor = cor.hex;
      div.style.border = '2px solid #ddd';
      div.style.borderRadius = '4px';
      div.title = cor.uso || cor.hex;
      container.appendChild(div);
    }
  });
  
  document.getElementById('cores-preview').classList.remove('d-none');
}

// === Carregar Dados Salvos ===
function carregarDadosSalvos() {
  let houveCarregamento = false;
  
  // Carregar layout salvo
  const layoutElement = document.getElementById('layout-data');
  if (layoutElement) {
    try {
      const layoutSalvo = JSON.parse(layoutElement.textContent);
      if (layoutSalvo && (layoutSalvo.areas || Object.keys(layoutSalvo).length > 0)) {
        resultadoEtapa1 = {
          layout: layoutSalvo,
          sucesso: true
        };
        
        document.getElementById('layout-json').textContent = JSON.stringify(layoutSalvo, null, 2);
        document.getElementById('result-1').classList.remove('d-none');
        atualizarStatus(1, 'salvo');
        houveCarregamento = true;
      }
    } catch (e) {
      console.error('Erro ao carregar layout:', e);
    }
  }
  
  // Carregar inspirações salvas
  const inspiracoesElement = document.getElementById('inspiracoes-data');
  if (inspiracoesElement) {
    try {
      const inspiracoesSalvas = JSON.parse(inspiracoesElement.textContent);
      if (inspiracoesSalvas && Object.keys(inspiracoesSalvas).length > 0) {
        resultadoEtapa2 = {
          inspiracoes: inspiracoesSalvas,
          sucesso: true
        };
        
        document.getElementById('inspiracoes-json').textContent = JSON.stringify(inspiracoesSalvas, null, 2);
        document.getElementById('result-2').classList.remove('d-none');
        
        if (inspiracoesSalvas.cores_predominantes) {
          mostrarPreviewCores(inspiracoesSalvas.cores_predominantes);
        }
        
        atualizarStatus(2, 'salvo');
        houveCarregamento = true;
      }
    } catch (e) {
      console.error('Erro ao carregar inspirações:', e);
    }
  }
  
  if (houveCarregamento) {
    document.getElementById('dados-salvos-info').classList.remove('d-none');
    verificarPreRequisitos();
  }
}

// === Inicialização ===
document.addEventListener('DOMContentLoaded', function() {
  // Carregar dados salvos
  carregarDadosSalvos();
  
  // Verificar disponibilidade de arquivos
  {% if not arquivos_planta %}
    document.getElementById('btn-etapa1').disabled = true;
    document.getElementById('btn-etapa1').innerHTML = '<i class="fas fa-times me-1"></i> Sem Esboços';
  {% endif %}
  
  {% if not arquivos_referencia %}
    document.getElementById('btn-etapa2').disabled = true;
    document.getElementById('btn-etapa2').innerHTML = '<i class="fas fa-times me-1"></i> Sem Referências';
  {% endif %}
});
</script>

<style>
/* Estilos customizados simplificados */
.badge.rounded-circle {
  width: 28px;
  height: 28px;
  padding: 0;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

#cores-container > div {
  cursor: pointer;
  transition: transform 0.2s;
}

#cores-container > div:hover {
  transform: scale(1.1);
}

#prompt-editor {
  font-size: 0.9rem;
  line-height: 1.5;
}

#prompt-usado-display {
  font-size: 0.85rem;
  line-height: 1.4;
  color: #495057;
}

.result-container img {
  cursor: zoom-in;
}

/* Animação para chamar atenção ao botão de regenerar */
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.pulse-animation {
  animation: pulse 1s ease-in-out 2;
}

#btn-regenerar-prompt {
  transition: all 0.3s ease;
}

#btn-regenerar-prompt:not(.d-none) {
  box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
}
</style>
{% endblock %}