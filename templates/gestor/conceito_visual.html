<!-- templates/gestor/conceito_visual.html -->
{% extends 'gestor/base_gestor.html' %}
{% load formatadores %}

{% block title %}Conceito Visual - {{ projeto.nome }} | Portal do Gestor{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <!-- CABEÇALHO -->
  <div class="card shadow mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <i class="fas fa-paint-brush me-2"></i>
        <h4 class="mb-0">Conceito Visual - {{ projeto.nome }}</h4>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-success" onclick="executarProcessoCompleto()">
          <i class="fas fa-play-circle me-1"></i> Executar Tudo
        </button>
        <button class="btn btn-outline-warning" onclick="limparResultados()">
          <i class="fas fa-broom me-1"></i> Limpar Cache
        </button>
        <a href="{% url 'gestor:projeto_detail' pk=projeto.id %}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- COLUNA ESQUERDA -->
    <div class="col-md-8">
      
      <!-- ETAPA 1: ANÁLISE DE ESBOÇO -->
      <div class="card shadow mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <span class="badge bg-primary rounded-circle me-2">1</span>
            Análise do Esboço
          </h5>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge" id="status-badge-1">Não Executado</span>
            <button class="btn btn-primary btn-sm" onclick="executarEtapa1Independente()" id="btn-etapa1">
              <i class="fas fa-play me-1"></i> Executar
            </button>
          </div>
        </div>
        <div class="card-body">
          <p class="text-muted">Interpreta a planta baixa desenhada e identifica áreas, dimensões e layout espacial.</p>
          
          <!-- Seletor de Arquivo -->
          <div class="mb-3" id="selector-arquivo-1">
            <label class="form-label">Selecione o esboço para análise:</label>
            <select class="form-select" id="select-esboco">
              <option value="">Usar primeiro arquivo disponível</option>
              {% for arquivo in arquivos_planta %}
                <option value="{{ arquivo.id }}">{{ arquivo.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Resultado -->
          <div class="result-container d-none" id="result-1">
            <div class="alert alert-success mb-3">
              <i class="fas fa-check-circle me-2"></i> Análise concluída com sucesso
              <span class="badge bg-info ms-2 d-none" id="badge-salvo-1">Dados Salvos</span>
            </div>
            
            <div class="row">
              <div class="col-md-8">
                <h6>Layout Identificado:</h6>
                <pre class="bg-light p-3 rounded small" id="layout-json" style="max-height: 300px; overflow-y: auto;"></pre>
              </div>
              <div class="col-md-4">
                <div id="arquivo-info-1" class="d-none">
                  <h6>Arquivo Analisado:</h6>
                  <div class="text-center">
                    <img id="esboco-thumb" src="" class="img-fluid rounded shadow-sm mb-2" style="max-height:200px;">
                    <p class="small text-muted mb-0" id="esboco-nome"></p>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="mt-3">
              <button class="btn btn-outline-primary btn-sm" onclick="baixarResultadoEtapa1()">
                <i class="fas fa-download me-1"></i> Baixar JSON
              </button>
              <button class="btn btn-outline-secondary btn-sm" onclick="reexecutarEtapa1()">
                <i class="fas fa-redo me-1"></i> Reexecutar
              </button>
            </div>
          </div>

          <!-- Loading -->
          <div class="text-center d-none" id="loading-1">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Processando...</span>
            </div>
            <p class="mt-2 text-muted">Analisando esboço...</p>
          </div>
        </div>
      </div>

      <!-- ETAPA 2: ANÁLISE DE REFERÊNCIAS -->
      <div class="card shadow mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <span class="badge bg-info rounded-circle me-2">2</span>
            Análise de Referências + Consolidação
          </h5>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge" id="status-badge-2">Não Executado</span>
            <button class="btn btn-info btn-sm" onclick="executarEtapa2Independente()" id="btn-etapa2">
              <i class="fas fa-play me-1"></i> Executar
            </button>
          </div>
        </div>
        <div class="card-body">
          <p class="text-muted">Extrai cores, estilos e inspirações das imagens de referência. Consolida dados e gera prompt final.</p>
          
          <!-- Opções -->
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="usar-layout-etapa1" checked>
            <label class="form-check-label" for="usar-layout-etapa1">
              Usar layout da Etapa 1 (se disponível)
            </label>
          </div>

          <!-- Resultado -->
          <div class="result-container d-none" id="result-2">
            <div class="alert alert-success mb-3">
              <i class="fas fa-check-circle me-2"></i> Análise e consolidação concluídas
              <span class="badge bg-info ms-2 d-none" id="badge-salvo-2">Dados Salvos</span>
            </div>
            
            <ul class="nav nav-tabs" role="tablist">
              <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#inspiracoes-tab">Inspirações</button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#dataset-tab">Dataset Consolidado</button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#prompt-tab">Prompt Final</button>
              </li>
            </ul>
            
            <div class="tab-content pt-3">
              <div class="tab-pane fade show active" id="inspiracoes-tab">
                <pre class="bg-light p-3 rounded small" id="inspiracoes-json" style="max-height: 300px; overflow-y: auto;"></pre>
              </div>
              <div class="tab-pane fade" id="dataset-tab">
                <pre class="bg-light p-3 rounded small" id="dataset-json" style="max-height: 300px; overflow-y: auto;"></pre>
              </div>
              <div class="tab-pane fade" id="prompt-tab">
                <div class="bg-light p-3 rounded" id="prompt-final"></div>
              </div>
            </div>
            
            <div class="mt-3">
              <button class="btn btn-outline-info btn-sm" onclick="baixarResultadoEtapa2()">
                <i class="fas fa-download me-1"></i> Baixar Dados
              </button>
              <button class="btn btn-outline-secondary btn-sm" onclick="reexecutarEtapa2()">
                <i class="fas fa-redo me-1"></i> Reexecutar
              </button>
            </div>
          </div>

          <!-- Loading -->
          <div class="text-center d-none" id="loading-2">
            <div class="spinner-border text-info" role="status">
              <span class="visually-hidden">Processando...</span>
            </div>
            <p class="mt-2 text-muted">Analisando referências e consolidando dados...</p>
          </div>
        </div>
      </div>

      <!-- ETAPA 3: GERAÇÃO DO CONCEITO -->
      <div class="card shadow mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <span class="badge bg-success rounded-circle me-2">3</span>
            Geração do Conceito Visual
          </h5>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge" id="status-badge-3">Não Executado</span>
            <button class="btn btn-success btn-sm" onclick="executarEtapa3Independente()" id="btn-etapa3">
              <i class="fas fa-play me-1"></i> Executar
            </button>
          </div>
        </div>
        <div class="card-body">
          <p class="text-muted">Gera a imagem final do conceito visual baseada no prompt consolidado.</p>
          
          <!-- Editor de Prompt -->
          <div class="mb-3">
            <label class="form-label">Prompt para geração:</label>
            <textarea class="form-control" id="prompt-editor" rows="4" placeholder="O prompt será carregado da Etapa 2 ou você pode editar manualmente..."></textarea>
            <small class="text-muted">Você pode editar o prompt antes de gerar a imagem</small>
          </div>

          <!-- Resultado -->
          <div class="result-container d-none" id="result-3">
            <div class="alert alert-success mb-3">
              <i class="fas fa-check-circle me-2"></i> Conceito visual gerado com sucesso
            </div>
            
            <div class="text-center">
              <img id="imagem-conceito" src="" alt="Conceito Visual" class="img-fluid rounded shadow mb-3" style="max-height:500px;">
              <div>
                <a id="link-download" href="" download class="btn btn-success me-2">
                  <i class="fas fa-download me-2"></i> Baixar Imagem
                </a>
                <button class="btn btn-outline-secondary" onclick="reexecutarEtapa3()">
                  <i class="fas fa-redo me-1"></i> Regenerar
                </button>
              </div>
            </div>
          </div>

          <!-- Loading -->
          <div class="text-center d-none" id="loading-3">
            <div class="spinner-border text-success" role="status">
              <span class="visually-hidden">Processando...</span>
            </div>
            <p class="mt-2 text-muted">Gerando conceito visual...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- COLUNA DIREITA -->
    <div class="col-md-4">
      <!-- Status Geral -->
      <div class="card shadow mb-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0"><i class="fas fa-tasks me-2"></i> Status do Processo</h5>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span>Etapa 1 - Esboço</span>
            <span id="status-1" class="badge bg-secondary">Pendente</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span>Etapa 2 - Referências</span>
            <span id="status-2" class="badge bg-secondary">Pendente</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span>Etapa 3 - Geração</span>
            <span id="status-3" class="badge bg-secondary">Pendente</span>
          </div>
          <hr>
          <div class="text-center">
            <small class="text-muted">Última atualização:</small><br>
            <span id="ultima-atualizacao">-</span>
          </div>
          
          <!-- Indicador de dados salvos -->
          <div class="mt-3 text-center d-none" id="indicador-dados-salvos">
            <small class="text-success">
              <i class="fas fa-database me-1"></i> Dados recuperados do banco
            </small>
          </div>
        </div>
      </div>

      <!-- Dados do Projeto -->
      <div class="card shadow mb-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i> Dados do Projeto</h5>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-5">Empresa:</dt>
            <dd class="col-7">{{ projeto.empresa.nome }}</dd>
            
            {% if briefing %}
              <dt class="col-5">Dimensões:</dt>
              <dd class="col-7">
                {% if briefing.medida_frente and briefing.medida_fundo %}
                  {{ briefing.medida_frente }}m × {{ briefing.medida_fundo }}m
                {% else %}
                  Não informado
                {% endif %}
              </dd>
              
              <dt class="col-5">Área:</dt>
              <dd class="col-7">
                {% if briefing.area_estande %}
                  {{ briefing.area_estande }}m²
                {% else %}
                  Não informado
                {% endif %}
              </dd>
              
              <dt class="col-5">Tipo Stand:</dt>
              <dd class="col-7">{{ briefing.get_tipo_stand_display|default:"Não informado" }}</dd>
              
              <dt class="col-5">Estilo:</dt>
              <dd class="col-7">{{ briefing.estilo_estande|default:"Não informado" }}</dd>
            {% endif %}
          </dl>
        </div>
      </div>

      <!-- Arquivos Disponíveis -->
      <div class="card shadow">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0"><i class="fas fa-folder-open me-2"></i> Arquivos Disponíveis</h5>
        </div>
        <div class="card-body">
          <h6 class="text-primary">Esboços ({{ arquivos_planta|length }})</h6>
          {% if arquivos_planta %}
            <ul class="list-unstyled small">
              {% for arquivo in arquivos_planta %}
                <li class="mb-1">
                  <i class="fas fa-file-image text-primary me-1"></i>
                  {{ arquivo.nome }}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted small">Nenhum esboço disponível</p>
          {% endif %}
          
          <h6 class="text-info mt-3">Referências ({{ arquivos_referencia|length }})</h6>
          {% if arquivos_referencia %}
            <ul class="list-unstyled small">
              {% for arquivo in arquivos_referencia %}
                <li class="mb-1">
                  <i class="fas fa-image text-info me-1"></i>
                  {{ arquivo.nome }}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted small">Nenhuma referência disponível</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Script tags para dados JSON -->
{% if projeto.layout_identificado %}
{{ projeto.layout_identificado|json_script:"layout-data" }}
{% endif %}
{% if projeto.inspiracoes_visuais %}
{{ projeto.inspiracoes_visuais|json_script:"inspiracoes-data" }}
{% endif %}

<script>
// === Estado Global ===
let resultadoEtapa1 = null;
let resultadoEtapa2 = null;
let resultadoEtapa3 = null;
let dadosCarregadosDoBanco = false;

// === CSRF Token ===
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
  return match ? decodeURIComponent(match[1]) : '';
}
const CSRF_TOKEN = getCookie('csrftoken');

// === ETAPA 1: Análise de Esboço ===
async function executarEtapa1Independente() {
  const arquivoId = document.getElementById('select-esboco').value;
  
  // UI
  document.getElementById('btn-etapa1').disabled = true;
  document.getElementById('loading-1').classList.remove('d-none');
  document.getElementById('result-1').classList.add('d-none');
  atualizarStatus(1, 'executando');
  
  try {
    const body = arquivoId ? JSON.stringify({arquivo_id: parseInt(arquivoId)}) : '{}';
    
    const response = await fetch(`/gestor/projeto/{{ projeto.id }}/conceito-visual/etapa1/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': CSRF_TOKEN,
        'Content-Type': 'application/json'
      },
      body: body
    });
    
    const data = await response.json();
    
    if (data.sucesso) {
      resultadoEtapa1 = data;
      
      // Mostrar resultado
      document.getElementById('layout-json').textContent = JSON.stringify(data.layout, null, 2);
      
      if (data.arquivo) {
        if (data.arquivo.nome) {
          document.getElementById('esboco-nome').textContent = data.arquivo.nome;
        }
        if (data.arquivo.url) {
          document.getElementById('esboco-thumb').src = data.arquivo.url;
        }
        document.getElementById('arquivo-info-1').classList.remove('d-none');
      }
      
      document.getElementById('result-1').classList.remove('d-none');
      document.getElementById('badge-salvo-1').classList.add('d-none'); // Não mostrar "Dados Salvos" em nova execução
      atualizarStatus(1, 'concluido');
      
    } else {
      alert(`Erro na Etapa 1: ${data.erro}`);
      atualizarStatus(1, 'erro');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao executar Etapa 1');
    atualizarStatus(1, 'erro');
  } finally {
    document.getElementById('btn-etapa1').disabled = false;
    document.getElementById('loading-1').classList.add('d-none');
  }
}

// === ETAPA 2: Análise de Referências ===
async function executarEtapa2Independente() {
  // UI
  document.getElementById('btn-etapa2').disabled = true;
  document.getElementById('loading-2').classList.remove('d-none');
  document.getElementById('result-2').classList.add('d-none');
  atualizarStatus(2, 'executando');
  
  try {
    const usarLayoutEtapa1 = document.getElementById('usar-layout-etapa1').checked;
    const body = {};
    
    if (usarLayoutEtapa1 && resultadoEtapa1 && resultadoEtapa1.layout) {
      body.layout = resultadoEtapa1.layout;
    }
    
    const response = await fetch(`/gestor/projeto/{{ projeto.id }}/conceito-visual/etapa2/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': CSRF_TOKEN,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    
    const data = await response.json();
    
    if (data.sucesso) {
      resultadoEtapa2 = data;
      
      // Mostrar resultados
      document.getElementById('inspiracoes-json').textContent = JSON.stringify(data.inspiracoes, null, 2);
      document.getElementById('dataset-json').textContent = JSON.stringify(data.dataset_consolidado, null, 2);
      document.getElementById('prompt-final').textContent = data.prompt_final;
      
      // Auto-preencher editor de prompt da Etapa 3
      document.getElementById('prompt-editor').value = data.prompt_final;
      
      document.getElementById('result-2').classList.remove('d-none');
      document.getElementById('badge-salvo-2').classList.add('d-none'); // Não mostrar "Dados Salvos" em nova execução
      atualizarStatus(2, 'concluido');
    } else {
      alert(`Erro na Etapa 2: ${data.erro}`);
      atualizarStatus(2, 'erro');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao executar Etapa 2');
    atualizarStatus(2, 'erro');
  } finally {
    document.getElementById('btn-etapa2').disabled = false;
    document.getElementById('loading-2').classList.add('d-none');
  }
}

// === ETAPA 3: Geração do Conceito ===
async function executarEtapa3Independente() {
  const prompt = document.getElementById('prompt-editor').value.trim();
  
  if (!prompt) {
    alert('Por favor, forneça um prompt para geração (execute a Etapa 2 ou escreva manualmente)');
    return;
  }
  
  // UI
  document.getElementById('btn-etapa3').disabled = true;
  document.getElementById('loading-3').classList.remove('d-none');
  document.getElementById('result-3').classList.add('d-none');
  atualizarStatus(3, 'executando');
  
  try {
    const response = await fetch(`/gestor/projeto/{{ projeto.id }}/conceito-visual/etapa3/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': CSRF_TOKEN,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ prompt: prompt })
    });
    
    const data = await response.json();
    
    if (data.sucesso) {
      resultadoEtapa3 = data;
      
      // Mostrar imagem
      document.getElementById('imagem-conceito').src = data.image_url;
      document.getElementById('link-download').href = data.download_url || data.image_url;
      
      document.getElementById('result-3').classList.remove('d-none');
      atualizarStatus(3, 'concluido');
    } else {
      alert(`Erro na Etapa 3: ${data.erro || 'Erro desconhecido'}`);
      atualizarStatus(3, 'erro');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao executar Etapa 3');
    atualizarStatus(3, 'erro');
  } finally {
    document.getElementById('btn-etapa3').disabled = false;
    document.getElementById('loading-3').classList.add('d-none');
  }
}

// === Processo Completo ===
async function executarProcessoCompleto() {
  if (confirm('Executar todas as etapas em sequência?')) {
    // Se não tiver resultado da Etapa 1, executar
    if (!resultadoEtapa1 || !resultadoEtapa1.layout) {
      await executarEtapa1Independente();
      // Aguardar um pouco para garantir que a etapa foi concluída
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    // Se tiver resultado da Etapa 1, executar Etapa 2
    if (resultadoEtapa1 && resultadoEtapa1.layout) {
      await executarEtapa2Independente();
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    // Se tiver resultado da Etapa 2, executar Etapa 3
    if (resultadoEtapa2 && resultadoEtapa2.prompt_final) {
      await executarEtapa3Independente();
    }
  }
}

// === Funções de Reexecução ===
function reexecutarEtapa1() {
  if (confirm('Reexecutar análise de esboço?')) {
    executarEtapa1Independente();
  }
}

function reexecutarEtapa2() {
  if (confirm('Reexecutar análise de referências?')) {
    executarEtapa2Independente();
  }
}

function reexecutarEtapa3() {
  if (confirm('Regenerar conceito visual?')) {
    executarEtapa3Independente();
  }
}

// === Funções de Download ===
function baixarResultadoEtapa1() {
  if (resultadoEtapa1) {
    const blob = new Blob([JSON.stringify(resultadoEtapa1.layout, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `layout_esboco_projeto_{{ projeto.id }}.json`;
    a.click();
  }
}

function baixarResultadoEtapa2() {
  if (resultadoEtapa2) {
    const dados = {
      inspiracoes: resultadoEtapa2.inspiracoes,
      dataset_consolidado: resultadoEtapa2.dataset_consolidado,
      prompt_final: resultadoEtapa2.prompt_final
    };
    const blob = new Blob([JSON.stringify(dados, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dados_consolidados_projeto_{{ projeto.id }}.json`;
    a.click();
  }
}

// === Funções Auxiliares ===
function atualizarStatus(etapa, status) {
  const badge = document.getElementById(`status-${etapa}`);
  const statusBadge = document.getElementById(`status-badge-${etapa}`);
  
  const configs = {
    'pendente': { class: 'bg-secondary', text: 'Pendente' },
    'executando': { class: 'bg-warning', text: 'Executando' },
    'concluido': { class: 'bg-success', text: 'Concluído' },
    'erro': { class: 'bg-danger', text: 'Erro' },
    'salvo': { class: 'bg-info', text: 'Dados Salvos' }
  };
  
  const config = configs[status] || configs['pendente'];
  
  [badge, statusBadge].forEach(el => {
    if (el) {
      el.className = `badge ${config.class}`;
      el.textContent = config.text;
    }
  });
  
  // Atualizar timestamp
  document.getElementById('ultima-atualizacao').textContent = new Date().toLocaleTimeString();
}

function limparResultados() {
  if (confirm('Limpar cache local? (Os dados salvos no banco permanecerão)')) {
    // Limpar estado local apenas
    resultadoEtapa1 = null;
    resultadoEtapa2 = null;
    resultadoEtapa3 = null;
    
    // Esconder resultados
    ['result-1', 'result-2', 'result-3'].forEach(id => {
      document.getElementById(id).classList.add('d-none');
    });
    
    // Reset status
    [1, 2, 3].forEach(etapa => {
      atualizarStatus(etapa, 'pendente');
    });
    
    // Limpar editor
    document.getElementById('prompt-editor').value = '';
    
    // Ocultar indicador
    document.getElementById('indicador-dados-salvos').classList.add('d-none');
    
    // Recarregar dados do banco
    setTimeout(() => {
      carregarDadosSalvos();
    }, 500);
  }
}

// === Carregar Dados Salvos do Banco ===
function carregarDadosSalvos() {
  let houveCarregamento = false;
  
  // Carregar layout salvo (Etapa 1)
  const layoutElement = document.getElementById('layout-data');
  if (layoutElement) {
    try {
      const layoutSalvo = JSON.parse(layoutElement.textContent);
      if (layoutSalvo && (layoutSalvo.areas || Object.keys(layoutSalvo).length > 0)) {
        resultadoEtapa1 = {
          layout: layoutSalvo,
          sucesso: true,
          carregadoDoBanco: true
        };
        
        // Mostrar resultado
        document.getElementById('layout-json').textContent = JSON.stringify(layoutSalvo, null, 2);
        document.getElementById('result-1').classList.remove('d-none');
        document.getElementById('badge-salvo-1').classList.remove('d-none');
        atualizarStatus(1, 'salvo');
        houveCarregamento = true;
        
        console.log('Layout carregado do banco de dados');
      }
    } catch (e) {
      console.error('Erro ao carregar layout salvo:', e);
    }
  }
  
  // Carregar inspirações salvas (Etapa 2)
  const inspiracoesElement = document.getElementById('inspiracoes-data');
  if (inspiracoesElement) {
    try {
      const inspiracoesSalvas = JSON.parse(inspiracoesElement.textContent);
      if (inspiracoesSalvas && Object.keys(inspiracoesSalvas).length > 0) {
        resultadoEtapa2 = {
          inspiracoes: inspiracoesSalvas,
          sucesso: true,
          carregadoDoBanco: true
        };
        
        // Mostrar resultado
        document.getElementById('inspiracoes-json').textContent = JSON.stringify(inspiracoesSalvas, null, 2);
        document.getElementById('result-2').classList.remove('d-none');
        document.getElementById('badge-salvo-2').classList.remove('d-none');
        
        document.getElementById('dataset-json').textContent = '// Dataset será gerado ao executar a etapa';
        document.getElementById('prompt-final').textContent = 'Prompt será gerado ao executar a etapa';
        
        atualizarStatus(2, 'salvo');
        houveCarregamento = true;
        
        console.log('Inspirações carregadas do banco de dados');
      }
    } catch (e) {
      console.error('Erro ao carregar inspirações salvas:', e);
    }
  }
  
  // Mostrar indicador se houve carregamento
  if (houveCarregamento) {
    document.getElementById('indicador-dados-salvos').classList.remove('d-none');
    dadosCarregadosDoBanco = true;
  }
}

// === Inicialização ===
document.addEventListener('DOMContentLoaded', function() {
  // Carregar dados salvos do banco
  carregarDadosSalvos();
  
  // Verificar se há esboços disponíveis
  if ({{ arquivos_planta|length }} === 0) {
    document.getElementById('btn-etapa1').disabled = true;
    document.getElementById('btn-etapa1').innerHTML = '<i class="fas fa-times me-1"></i> Sem Esboços';
  }
  
  // Verificar se há referências disponíveis
  if ({{ arquivos_referencia|length }} === 0) {
    console.log('Aviso: Sem arquivos de referência, mas a etapa 2 ainda pode executar');
  }
  
  // Se tiver dados carregados, atualizar timestamp
  if (dadosCarregadosDoBanco) {
    document.getElementById('ultima-atualizacao').textContent = 'Dados recuperados';
  }
});
</script>

<style>
.nav-link {
  color: #6c757d;
  border: 1px solid transparent;
}

.nav-link.active {
  color: #495057;
  background-color: #fff;
  border-color: #dee2e6 #dee2e6 #fff;
}

.tab-content {
  border: 1px solid #dee2e6;
  border-top: none;
  background: white;
}

.badge.rounded-circle {
  width: 28px;
  height: 28px;
  padding: 0;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

#indicador-dados-salvos {
  animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
</style>
{% endblock %}