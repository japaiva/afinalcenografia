<!-- templates/gestor/modelo_3d_wizard.html -->
{% extends 'gestor/base_gestor.html' %}
{% load static formatadores %}

{% block title %}Modelo 3D - {{ projeto.nome }} | Portal do Gestor{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <!-- CABEÇALHO -->
  <div class="card shadow mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <i class="fas fa-cube me-2"></i>
        <div>
          <h4 class="mb-0">Modelo 3D</h4>
          <small class="text-muted">{{ projeto.empresa.nome }} | {{ projeto.nome }}</small>
        </div>
      </div>
      <div>
        <a href="{% url 'gestor:projeto_detail' pk=projeto.id %}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- COLUNA ESQUERDA (2/3) -->
    <div class="col-md-8">

      <!-- ETAPA: GERAÇÃO DO MODELO 3D -->
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <span class="badge bg-white text-primary rounded-circle me-2">1</span>
            Gerar Modelo 3D
          </h5>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-light text-dark">
              {% if modelo_3d_gerado %}Concluído{% else %}Pendente{% endif %}
            </span>
            <button class="btn btn-light btn-sm" onclick="gerarModelo3D()" id="btn-gerar">
              <i class="fas fa-play text-primary me-1"></i> Gerar Modelo 3D
            </button>
          </div>
        </div>
        <div class="card-body">
          <p class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Gera modelo 3D enriquecido combinando dados de planta baixa, briefing e renderização AI.
          </p>

          {% if dimensoes %}
          <div class="alert alert-light border mb-3">
            <strong><i class="fas fa-layer-group me-1"></i> Planta Baixa:</strong>
            <ul class="mb-0 mt-2">
              <li>Dimensões: {{ dimensoes.largura|default:"?" }}m × {{ dimensoes.profundidade|default:"?" }}m × {{ dimensoes.altura|default:3 }}m</li>
              <li>Área: {{ dimensoes.area_total|default:"?" }}m²</li>
              <li>Áreas internas: {{ total_areas }} ({% for area in areas %}{{ area.nome }}{% if not forloop.last %}, {% endif %}{% endfor %})</li>
            </ul>
          </div>
          {% endif %}

          {% if tem_briefing %}
          <div class="alert alert-light border mb-3">
            <strong><i class="fas fa-file-alt me-1"></i> Briefing:</strong>
            <ul class="mb-0 mt-2">
              <li>Altura máxima, estilo do stand</li>
              <li>Cores da marca (aplicadas aos materiais)</li>
            </ul>
          </div>
          {% endif %}

          {% if tem_renderizacao %}
          <div class="alert alert-light border mb-3">
            <strong><i class="fas fa-palette me-1"></i> Renderização AI:</strong>
            <ul class="mb-0 mt-2">
              <li>Mobiliário detalhado (mesas, balcões, sofás, vitrines)</li>
              <li>Especificação de materiais</li>
              <li>Iluminação e detalhes visuais</li>
            </ul>
          </div>
          {% endif %}

          <!-- RESULTADO (quando implementado) -->
          <div id="resultado-gerar" class="d-none">
            <div class="alert alert-success mb-3">
              <i class="fas fa-check-circle me-2"></i>
              <strong>Modelo 3D gerado com sucesso!</strong>
            </div>

            <div class="text-center">
              <i class="fas fa-cube" style="font-size: 4rem; color: #6c757d;"></i>
              {% if projeto.arquivo_3d %}
              <p class="mt-3">Arquivo: <strong>{{ projeto.arquivo_3d.name }}</strong></p>
              {% else %}
              <p class="mt-3">Modelo 3D gerado</p>
              {% endif %}

              <button class="btn btn-primary" onclick="baixarModelo3D()">
                <i class="fas fa-download me-1"></i> Baixar Modelo (.obj)
              </button>
            </div>
          </div>

          <!-- ERRO -->
          <div id="erro-gerar" class="d-none">
            <div class="alert alert-danger mb-0">
              <i class="fas fa-exclamation-circle me-2"></i>
              <strong>Erro:</strong> <span id="mensagem-erro-gerar"></span>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- COLUNA DIREITA (1/3) -->
    <div class="col-md-4">
      <!-- Status Geral -->
      <div class="card shadow mb-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0"><i class="fas fa-tasks me-2"></i> Status do Processo</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <span><i class="fas fa-cube me-1 text-primary"></i> Modelo 3D</span>
              <span class="badge {% if modelo_3d_gerado %}bg-success{% else %}bg-secondary{% endif %}">
                {% if modelo_3d_gerado %}Concluído{% else %}Pendente{% endif %}
              </span>
            </div>
          </div>

          <hr>

          <div class="text-center">
            {% if modelo_3d_gerado %}
            <small class="text-success d-block">
              <i class="fas fa-check-circle me-1"></i> Modelo 3D gerado
            </small>
            <small class="text-muted d-block mt-1">
              Gerado em: {{ projeto.data_modelo_3d|date:"d/m/Y H:i" }}
            </small>
            {% else %}
            <small class="text-muted d-block">
              Clique em "Gerar Modelo 3D" para criar
            </small>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Dados da Renderização AI -->
      <div class="card shadow mb-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i> Renderização AI</h5>
        </div>
        <div class="card-body">
          {% if projeto.renderizacao_ai_processada %}
          <dl class="row mb-0">
            <dt class="col-5">Status:</dt>
            <dd class="col-7"><span class="badge bg-success">Processada</span></dd>

            <dt class="col-5">Processada em:</dt>
            <dd class="col-7 small">{{ projeto.data_renderizacao_ai|date:"d/m/Y H:i" }}</dd>

            <dt class="col-5">Imagem:</dt>
            <dd class="col-7">
              {% if projeto.imagem_conceito_url %}
                <a href="{{ projeto.imagem_conceito_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-external-link-alt me-1"></i> Ver
                </a>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </dd>
          </dl>
          {% else %}
          <p class="text-muted mb-0">Renderização AI não processada</p>
          {% endif %}
        </div>
      </div>

      <!-- Informações da Feira -->
      {% if projeto.feira %}
      <div class="card shadow">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0"><i class="fas fa-calendar-alt me-2"></i> Feira</h5>
        </div>
        <div class="card-body">
          <h6 class="mb-2">{{ projeto.feira.nome }}</h6>
          <p class="text-muted small mb-2">
            {{ projeto.feira.local|default:"Local não informado" }}
          </p>
          {% if projeto.feira.data_inicio and projeto.feira.data_fim %}
          <p class="text-muted small mb-2">
            <i class="fas fa-clock me-1"></i>
            {{ projeto.feira.data_inicio|date:"d/m/Y" }} a {{ projeto.feira.data_fim|date:"d/m/Y" }}
          </p>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
// Geração de Modelo 3D
function gerarModelo3D() {
  const btn = document.getElementById('btn-gerar');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Gerando...';

  // Esconder resultados anteriores
  document.getElementById('resultado-gerar').classList.add('d-none');
  document.getElementById('erro-gerar').classList.add('d-none');

  fetch("{% url 'gestor:modelo_3d_gerar' projeto_id=projeto.id %}", {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-play text-primary me-1"></i> Gerar Modelo 3D';

    if (data.sucesso) {
      document.getElementById('resultado-gerar').classList.remove('d-none');

      // Atualizar info de metadados se disponível
      if (data.metadados) {
        const meta = data.metadados;
        console.log('Modelo gerado:', meta);
      }

      // Listar fontes de dados usadas
      let fontesHtml = '';
      if (data.metadados?.fontes_dados) {
        fontesHtml = `<p><strong>Fontes utilizadas:</strong> ${data.metadados.fontes_dados.join(', ')}</p>`;
      }

      Swal.fire({
        icon: 'success',
        title: 'Modelo 3D Gerado!',
        html: `
          <p>Modelo 3D enriquecido gerado com sucesso.</p>
          ${fontesHtml}
          <p><strong>Vértices:</strong> ${data.metadados?.vertices || '-'}</p>
          <p><strong>Faces:</strong> ${data.metadados?.faces || '-'}</p>
          <p><strong>Mobiliário gerado:</strong> ${data.metadados?.mobiliario_gerado || 0} itens</p>
        `,
        confirmButtonText: 'OK'
      });
    } else {
      document.getElementById('mensagem-erro-gerar').textContent = data.erro;
      document.getElementById('erro-gerar').classList.remove('d-none');

      Swal.fire({
        icon: 'error',
        title: 'Erro',
        text: data.erro,
        confirmButtonText: 'OK'
      });
    }
  })
  .catch(error => {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-play text-primary me-1"></i> Gerar Modelo 3D';

    Swal.fire({
      icon: 'error',
      title: 'Erro de Conexão',
      text: 'Não foi possível conectar ao servidor.',
      confirmButtonText: 'OK'
    });
  });
}

function baixarModelo3D() {
  {% if projeto.arquivo_3d %}
  window.location.href = "{{ projeto.arquivo_3d.url }}";
  {% else %}
  // Tentar download mesmo sem arquivo salvo (gera sob demanda)
  window.location.href = "{% url 'gestor:modelo_3d_download' projeto_id=projeto.id %}";
  {% endif %}
}

function baixarMTL() {
  window.location.href = "{% url 'gestor:modelo_3d_download_mtl' projeto_id=projeto.id %}";
}
</script>
{% endblock %}
