{% extends 'gestor/base_gestor.html' %}
{% load static %}

{% block title %}{{ feira.nome }} | Portal do Gestor | Afinal Cenografia{% endblock %}

{% block content %}
<div class="card shadow" style="max-width: 1400px; margin: 0 auto;" data-feira-id="{{ feira.id }}">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="fas fa-calendar-alt me-2"></i> {{ feira.nome }}
    </h5>
    <div>
      <a href="{% url 'gestor:feira_update' feira.id %}" class="btn btn-outline-primary btn-sm me-1">
        <i class="fas fa-edit me-1"></i> Editar
      </a>
      <a href="{% url 'gestor:feira_toggle_status' feira.id %}" class="btn btn-sm {% if feira.ativa %}btn-outline-danger{% else %}btn-outline-success{% endif %}">
        <i class="fas {% if feira.ativa %}fa-ban{% else %}fa-check-circle{% endif %} me-1"></i>
        {% if feira.ativa %}Desativar{% else %}Ativar{% endif %}
      </a>
    </div>
  </div>

  <div class="card-body">
    <div class="row" style="max-width: 100%; margin: 0;">
      <!-- COLUNA 1 -->
      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">Informações Gerais</h6>
          </div>
          <div class="card-body p-0">
            <ul class="list-group list-group-flush">
              <li class="list-group-item"><strong>Nome:</strong> {{ feira.nome }}</li>
              <li class="list-group-item"><strong>Local:</strong> {{ feira.local }}</li>
              <li class="list-group-item"><strong>Cidade/UF:</strong> {{ feira.cidade }}/{{ feira.estado }}</li>
              <li class="list-group-item"><strong>Período:</strong> {{ feira.data_inicio|date:"d/m/Y" }} a {{ feira.data_fim|date:"d/m/Y" }}</li>
              <li class="list-group-item"><strong>Website:</strong>
                {% if feira.website %}
                  <a href="{{ feira.website }}" target="_blank">{{ feira.website }}</a>
                {% else %}-{% endif %}
              </li>
              <li class="list-group-item">
                <strong>Status:</strong>
                <span class="badge {% if feira.ativa %}bg-success{% else %}bg-danger{% endif %}">
                  {% if feira.ativa %}Ativa{% else %}Inativa{% endif %}
                </span>
              </li>
            </ul>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">Contato</h6>
          </div>
          <div class="card-body p-0">
            <ul class="list-group list-group-flush">
              <li class="list-group-item"><strong>Nome:</strong> {{ feira.contato_organizacao|default:"-" }}</li>
              <li class="list-group-item"><strong>Email:</strong> {{ feira.email_organizacao|default:"-" }}</li>
              <li class="list-group-item"><strong>Telefone:</strong> {{ feira.telefone_organizacao|default:"-" }}</li>
            </ul>
          </div>
        </div>
        
        <!-- NOVO CARD: Pesquisa no Manual -->
        {% if feira.manual_processado %}
        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">Consultar Manual</h6>
          </div>
          <div class="card-body">
            <form id="manualSearchForm" class="mb-3">
              <div class="input-group">
                <input type="text" id="manualSearchQuery" class="form-control" placeholder="Digite sua pergunta sobre o manual...">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-search me-1"></i> Consultar
                </button>
              </div>
            </form>
            <div id="manualSearchResults" class="d-none">
              <hr>
              <h6 class="text-primary">Resposta:</h6>
              <div id="searchResponseContainer" class="p-3 bg-light rounded mb-3"></div>
              
              <div id="searchContextsContainer">
                <h6 class="text-secondary">Contextos utilizados:</h6>
                <div id="searchContextsList" class="mt-2"></div>
              </div>
            </div>
            
            <div id="manualSearchLoading" class="text-center d-none">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
              </div>
              <p>Consultando o manual, por favor aguarde...</p>
            </div>
            
            <div id="manualSearchError" class="alert alert-danger d-none"></div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- COLUNA 2 -->
      <div class="col-md-6">
        {% if feira.manual %}
        <!-- Versão corrigida para alinhamento do Q&A e sem barra de progresso -->
        <div class="card">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">Processamento do Manual</h6>
          </div>
          <div class="card-body p-0">
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div><strong>Manual:</strong> {{ feira.total_chunks|default:"0" }} blocos</div>
                <span id="manual-status" class="badge {% if feira.processamento_status == 'processando' %}bg-warning text-dark{% elif feira.manual_processado %}bg-success{% elif feira.processamento_status == 'erro' %}bg-danger{% else %}bg-secondary{% endif %}">
                  {% if feira.processamento_status == 'processando' %}
                    Processando
                  {% elif feira.manual_processado %}
                    Concluído
                  {% elif feira.processamento_status == 'erro' %}
                    Erro
                  {% else %}
                    Pendente
                  {% endif %}
                </span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div><strong>Q&A:</strong> <span id="qa-count">{{ qa_count|default:"0" }}</span> perguntas</div>
                <span id="qa-status" class="badge {% if qa_processando %}bg-warning text-dark{% elif qa_count > 0 %}bg-success{% else %}bg-secondary{% endif %}">
                  {% if qa_processando %}
                    Processando
                  {% elif qa_count > 0 %}
                    Concluído
                  {% else %}
                    Pendente
                  {% endif %}
                </span>
              </li>
              <!-- Mensagem de progresso sem a barra -->
              <li id="progress-container" class="list-group-item {% if feira.processamento_status != 'processando' and not qa_processando %}d-none{% endif %}">
                <small id="progress-text" class="text-muted">
                  {% if feira.processamento_status == 'processando' %}
                    Processando manual... ({{ feira.progresso_processamento }}%)
                  {% elif qa_processando %}
                    Gerando Q&A...
                  {% endif %}
                </small>
              </li>
            </ul>
            <div class="p-3 d-flex flex-wrap gap-2">
              <!-- Botão para processar manual -->
              <form id="process-manual-form" method="post" action="{% url 'gestor:feira_reprocess' feira.id %}" class="me-2">
                {% csrf_token %}
                <button type="submit" id="process-manual-button" class="btn btn-primary" {% if feira.processamento_status == 'processando' %}disabled{% endif %}>
                  <i class="fas {% if feira.processamento_status == 'processando' %}fa-spinner fa-spin{% else %}fa-sync-alt{% endif %} me-1"></i> 
                  {% if feira.processamento_status == 'processando' %}
                    Processando...
                  {% elif feira.manual_processado %}
                    Reprocessar Manual
                  {% else %}
                    Processar Manual
                  {% endif %}
                </button>
              </form>
              
              <!-- Botão para gerar Q&A -->
              <form id="process-qa-form" method="post" action="{% url 'gestor:feira_qa_regenerate' feira.id %}" class="me-2">
                {% csrf_token %}
                <button type="submit" id="process-qa-button" class="btn btn-success" {% if not feira.manual_processado or qa_processando %}disabled{% endif %}>
                  <i class="fas {% if qa_processando %}fa-spinner fa-spin{% else %}fa-comment-dots{% endif %} me-1"></i> 
                  {% if qa_processando %}
                    Processando...
                  {% elif qa_count > 0 %}
                    Reprocessar Q&A
                  {% else %}
                    Gerar Q&A
                  {% endif %}
                </button>
              </form>
              
              <!-- Botão para ver Q&A (só aparece se já houver Q&A gerados) -->
              {% if qa_count > 0 %}
              <a href="{% url 'gestor:feira_qa_list' feira.id %}" class="btn btn-outline-info">
                <i class="fas fa-list me-1"></i> Ver Q&A
              </a>
              {% endif %}
            </div>
          </div>
        </div>
        {% else %}
        <div class="alert alert-warning mt-3">
          <i class="fas fa-exclamation-triangle me-1"></i> Esta feira não possui um manual cadastrado.
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card-footer bg-white">
    <a href="{% url 'gestor:feira_list' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i> Voltar para Lista
    </a>
  </div>
</div>

{% csrf_token %}
<!-- Link para o script externo -->
<script src="{% static 'js/feira_detail.js' %}"></script>
{% endblock %}