{% extends 'gestor/base_gestor.html' %}

{% block title %}Detalhes do Projeto #{{ projeto.numero }} | Portal do Gestor | Afinal Cenografia{% endblock %}

{% block content %}
<div class="card shadow">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="fas fa-project-diagram me-2"></i> Projeto #{{ projeto.numero }} - {{ projeto.nome }}
    </h5>
    <div>
      {% if projeto.has_briefing %}
      <a href="{% url 'gestor:ver_briefing' projeto_id=projeto.id %}" class="btn btn-success btn-sm">
        <i class="fas fa-clipboard-list me-1"></i> Acessar Briefing
      </a>
      {% endif %}
      <a href="{% url 'gestor:mensagens_projeto' projeto_id=projeto.id %}" class="btn btn-outline-info btn-sm ms-2">
        <i class="fas fa-comments me-1"></i> Acessar Mensagens
      </a>
      <a href="{% url 'gestor:projeto_list' %}" class="btn btn-outline-secondary btn-sm ms-2">
        <i class="fas fa-arrow-left me-1"></i> Voltar
      </a>
    </div>
  </div>
  
  <div class="card-body">
    <div class="row">
      <!-- Informações básicas -->
      <div class="col-md-8">
        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">Informações Básicas</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Número</label>
                <p class="border-bottom pb-2">{{ projeto.numero }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Status</label>
                <p class="border-bottom pb-2">
                  <span class="badge 
                    {% if projeto.status == 'briefing_pendente' %}bg-info
                    {% elif projeto.status == 'briefing_validado' %}bg-success
                    {% elif projeto.status == 'briefing_enviado' %}bg-info
                    {% elif projeto.status == 'projeto_em_desenvolvimento' %}bg-primary
                    {% elif projeto.status == 'projeto_enviado' %}bg-info
                    {% elif projeto.status == 'projeto_em_analise' %}bg-warning text-dark
                    {% elif projeto.status == 'projeto_aprovado' %}bg-success
                    {% elif projeto.status == 'em_producao' %}bg-danger
                    {% elif projeto.status == 'concluido' %}bg-secondary
                    {% elif projeto.status == 'cancelado' %}bg-danger
                    {% else %}bg-secondary{% endif %}">
                    {{ projeto.get_status_display }}
                  </span>
                </p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Empresa</label>
                <p class="border-bottom pb-2">{{ projeto.empresa.nome }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Criado por</label>
                <p class="border-bottom pb-2">
                  {% if projeto.criado_por %}
                    {{ projeto.criado_por.get_full_name|default:projeto.criado_por.username }}
                  {% else %}
                    <span class="text-muted">Não disponível</span>
                  {% endif %}
                </p>
              </div>
              <div class="col-md-12 mb-3">
                <label class="form-label fw-bold">Objetivo</label>
                <p class="border-bottom pb-2">{{ projeto.descricao|default:"-" }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Data de Criação</label>
                <p class="border-bottom pb-2">{{ projeto.created_at|date:"d/m/Y H:i" }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Última Atualização</label>
                <p class="border-bottom pb-2">{{ projeto.updated_at|date:"d/m/Y H:i" }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Orçamento</label>
                <p class="border-bottom pb-2">R$ {{ projeto.orcamento|floatformat:2 }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Progresso</label>
                <div class="progress mb-2" style="height: 10px;">
                  <div class="progress-bar bg-success" role="progressbar" style="width: {{ projeto.progresso }}%;" aria-valuenow="{{ projeto.progresso }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <small class="text-muted">{{ projeto.progresso }}% concluído</small>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Informações da Feira -->
        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">Informações da Feira</h6>
          </div>
          <div class="card-body">
            {% if projeto.feira %}
            <div class="row">
              <div class="col-md-12 mb-3">
                <label class="form-label fw-bold">Nome da Feira</label>
                <p class="border-bottom pb-2">{{ projeto.feira.nome }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Local</label>
                <p class="border-bottom pb-2">{{ projeto.feira.local|default:"-" }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Cidade/UF</label>
                <p class="border-bottom pb-2">{{ projeto.feira.cidade }}/{{ projeto.feira.estado }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Data Início</label>
                <p class="border-bottom pb-2">{{ projeto.feira.data_inicio|date:"d/m/Y" }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Data Fim</label>
                <p class="border-bottom pb-2">{{ projeto.feira.data_fim|date:"d/m/Y" }}</p>
              </div>
              
              {% if projeto.feira.manual %}
              <div class="col-12">
                <a href="{{ projeto.feira.manual.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                  <i class="fas fa-file-pdf me-1"></i> Baixar Manual da Feira
                </a>
              </div>
              {% endif %}
            </div>
            {% else %}
            <div class="alert alert-warning mb-0">
              <i class="fas fa-exclamation-triangle me-2"></i> Este projeto não possui feira associada.
            </div>
            {% endif %}
          </div>
        </div>
        
        <!-- Marcos do Projeto -->
        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">Marcos do Projeto</h6>
          </div>
          <div class="card-body p-0">
            <div class="timeline-container p-3">
              {% for marco in marcos %}
              <div class="timeline-item mb-3">
                <div class="timeline-marker 
                  {% if marco.tipo == 'criacao_projeto' %}bg-secondary
                  {% elif marco.tipo == 'envio_briefing' %}bg-info
                  {% elif marco.tipo == 'validacao_briefing' %}bg-success
                  {% elif marco.tipo == 'inicio_desenvolvimento' %}bg-primary
                  {% elif marco.tipo == 'envio_projeto' %}bg-info
                  {% elif marco.tipo == 'analise_projeto' %}bg-warning
                  {% elif marco.tipo == 'aprovacao_projeto' %}bg-success
                  {% elif marco.tipo == 'inicio_producao' %}bg-danger
                  {% elif marco.tipo == 'entrega_estande' %}bg-success
                  {% elif marco.tipo == 'cancelamento' %}bg-danger
                  {% else %}bg-secondary{% endif %}">
                </div>
                <div class="timeline-content">
                  <div class="d-flex justify-content-between">
                    <h6 class="fw-bold mb-1">{{ marco.get_tipo_display }}</h6>
                    <small class="text-muted">{{ marco.data|date:"d/m/Y H:i" }}</small>
                  </div>
                  <p class="mb-0">{{ marco.observacao|default:"" }}</p>
                  {% if marco.registrado_por %}
                  <small class="text-muted">Registrado por: {{ marco.registrado_por.get_full_name|default:marco.registrado_por.username }}</small>
                  {% endif %}
                </div>
              </div>
              {% empty %}
              <div class="text-center py-3 text-muted">Nenhum marco registrado para este projeto.</div>
              {% endfor %}
            </div>
          </div>
        </div>
        
        <!-- Briefings do Projeto -->
        <div class="card mb-3">
          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0">Briefings do Projeto</h6>
            {% if projeto.has_briefing %}
            <a href="{% url 'gestor:ver_briefing' projeto_id=projeto.id %}" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-eye me-1"></i> Ver Detalhes
            </a>
            {% endif %}
          </div>
          <div class="card-body">
            {% if briefings %}
            <div class="table-responsive">
              <table class="table table-hover table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Versão</th>
                    <th>Status</th>
                    <th>Progresso</th>
                    <th>Criado em</th>
                    <th>Atualizado em</th>
                    <th class="text-end">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {% for briefing in briefings %}
                  <tr>
                    <td>v{{ briefing.versao }}</td>
                    <td>
                      <span class="badge 
                        {% if briefing.status == 'rascunho' %}bg-secondary
                        {% elif briefing.status == 'em_validacao' %}bg-warning text-dark
                        {% elif briefing.status == 'validado' %}bg-success
                        {% elif briefing.status == 'enviado' %}bg-primary
                        {% elif briefing.status == 'revisao' %}bg-info
                        {% elif briefing.status == 'aprovado' %}bg-success
                        {% endif %}">
                        {{ briefing.get_status_display }}
                      </span>
                    </td>
                    <td>
                      <div class="progress" style="height: 5px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ briefing.progresso }}%;" 
                             aria-valuenow="{{ briefing.progresso }}" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                      <small>{{ briefing.progresso }}%</small>
                    </td>
                    <td>{{ briefing.created_at|date:"d/m/Y" }}</td>
                    <td>{{ briefing.updated_at|date:"d/m/Y" }}</td>
                    <td class="text-end">
                      <a href="{% url 'gestor:ver_briefing' projeto_id=projeto.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i>
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="alert alert-info mb-0">
              <i class="fas fa-info-circle me-2"></i> Este projeto ainda não possui briefings.
            </div>
            {% endif %}
          </div>
        </div>
        
        <!-- Arquivos e Referências -->
        <div class="card mb-3">
          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0">Arquivos e Referências</h6>
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
              <i class="fas fa-upload me-1"></i> Adicionar Arquivo
            </button>
          </div>
          <div class="card-body">
            <ul class="nav nav-tabs" id="arquivosTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-plantas" data-bs-toggle="tab" data-bs-target="#plantas-content" type="button">
                  <i class="fas fa-map me-1"></i> Plantas
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-referencias" data-bs-toggle="tab" data-bs-target="#referencias-content" type="button">
                  <i class="fas fa-images me-1"></i> Referências
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-arquivos" data-bs-toggle="tab" data-bs-target="#arquivos-content" type="button">
                  <i class="fas fa-file me-1"></i> Outros Arquivos
                </button>
              </li>
            </ul>
            
            <div class="tab-content p-3 border border-top-0 rounded-bottom">
              <!-- Plantas -->
              <div class="tab-pane fade show active" id="plantas-content" role="tabpanel" aria-labelledby="tab-plantas">
                {% if plantas %}
                <div class="d-flex flex-wrap gap-3">
                  {% for planta in plantas %}
                  <div class="arquivo-item">
                    <div class="card" style="width: 200px;">
                      <div class="card-header p-2 bg-light d-flex justify-content-between align-items-center">
                        <span class="small text-truncate">{{ planta.nome }}</span>
                        <button type="button" class="btn btn-sm btn-danger p-0 px-1 excluir-arquivo" data-url="#">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                      <div class="card-body p-2 text-center">
                        <i class="fas fa-map fa-3x text-secondary mb-2"></i>
                        <p class="small text-muted mb-1">{{ planta.get_tipo_display }}</p>
                        <a href="{{ planta.arquivo.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                          <i class="fas fa-download me-1"></i> Baixar
                        </a>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                  <i class="fas fa-map fa-2x text-muted mb-2"></i>
                  <p>Nenhuma planta cadastrada.</p>
                </div>
                {% endif %}
              </div>
              
              <!-- Referências -->
              <div class="tab-pane fade" id="referencias-content" role="tabpanel" aria-labelledby="tab-referencias">
                {% if referencias %}
                <div class="d-flex flex-wrap gap-3">
                  {% for referencia in referencias %}
                  <div class="arquivo-item">
                    <div class="card" style="width: 200px;">
                      <div class="card-header p-2 bg-light d-flex justify-content-between align-items-center">
                        <span class="small text-truncate">{{ referencia.nome }}</span>
                        <button type="button" class="btn btn-sm btn-danger p-0 px-1 excluir-arquivo" data-url="#">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                      {% if referencia.tipo == 'imagem' or referencia.tipo == 'logotipo' or referencia.tipo == 'estilo_visual' or referencia.tipo == 'campanha' %}
                      <img src="{{ referencia.arquivo.url }}" class="card-img-top" alt="{{ referencia.nome }}" style="height: 120px; object-fit: cover;">
                      {% else %}
                      <div class="card-body p-2 text-center">
                        <i class="fas 
                          {% if referencia.tipo == 'documento' %}fa-file-alt
                          {% elif referencia.tipo == 'estande_anterior' %}fa-building
                          {% else %}fa-file{% endif %} fa-3x text-secondary mb-2"></i>
                      </div>
                      {% endif %}
                      <div class="card-footer p-2 text-center">
                        <p class="small text-muted mb-1">{{ referencia.get_tipo_display }}</p>
                        <a href="{{ referencia.arquivo.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                          <i class="fas fa-download me-1"></i> Baixar
                        </a>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                  <i class="fas fa-images fa-2x text-muted mb-2"></i>
                  <p>Nenhuma referência cadastrada.</p>
                </div>
                {% endif %}
              </div>
              
              <!-- Outros Arquivos -->
              <div class="tab-pane fade" id="arquivos-content" role="tabpanel" aria-labelledby="tab-arquivos">
                {% if projeto.arquivos.all %}
                <div class="list-group">
                  {% for arquivo in projeto.arquivos.all %}
                  <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <i class="fas fa-file me-2"></i>
                      {{ arquivo.nome_original }}
                    </div>
                    <div>
                      <a href="{{ arquivo.arquivo.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                        <i class="fas fa-download"></i>
                      </a>
                      <button type="button" class="btn btn-sm btn-outline-danger ms-1 excluir-arquivo" data-url="#">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                  <i class="fas fa-file fa-2x text-muted mb-2"></i>
                  <p>Nenhum arquivo cadastrado.</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Coluna direita -->
      <div class="col-md-4">
        <!-- Cliente e Empresa -->
        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">Cliente e Empresa</h6>
          </div>
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white me-3" style="width: 50px; height: 50px;">
                {% if projeto.criado_por %}
                  {{ projeto.criado_por.get_full_name|default:projeto.criado_por.username|slice:":1"|upper }}
                {% else %}
                  ?
                {% endif %}
              </div>
              <div>
                <h6 class="mb-0">
                  {% if projeto.criado_por %}
                    {{ projeto.criado_por.get_full_name|default:projeto.criado_por.username }}
                  {% else %}
                    <span class="text-muted">Usuário não disponível</span>
                  {% endif %}
                </h6>
                <small class="text-muted">
                  {% if projeto.criado_por %}
                    {{ projeto.criado_por.email }}
                  {% else %}
                    -
                  {% endif %}
                </small>
              </div>
            </div>
            
            <div class="d-flex align-items-center mb-3">
              <div class="bg-secondary rounded d-flex align-items-center justify-content-center text-white me-3" style="width: 50px; height: 50px;">
                {{ projeto.empresa.nome|slice:":1"|upper }}
              </div>
              <div>
                <h6 class="mb-0">{{ projeto.empresa.nome }}</h6>
                <small class="text-muted">{{ projeto.empresa.segmento|default:"" }}</small>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Projetista - Será implementado posteriormente -->
        <!-- 
        <div class="card mb-3">
          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0">Projetista Responsável</h6>
            {% if projeto.projetista %}
              <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#alterarProjetistaModal">
                <i class="fas fa-user-edit me-1"></i> Alterar
              </button>
            {% endif %}
          </div>
          <div class="card-body">
            {% if projeto.projetista %}
              <div class="d-flex align-items-center mb-3">
                <div class="bg-success rounded-circle d-flex align-items-center justify-content-center text-white me-3" style="width: 50px; height: 50px;">
                  {{ projeto.projetista.get_full_name|default:projeto.projetista.username|slice:":1"|upper }}
                </div>
                <div>
                  <h6 class="mb-0">{{ projeto.projetista.get_full_name|default:projeto.projetista.username }}</h6>
                  <small class="text-muted">{{ projeto.projetista.email }}</small>
                </div>
              </div>
            {% else %}
              <div class="text-center py-3">
                <i class="fas fa-user-plus fa-2x mb-3 text-muted"></i>
                <p>Nenhum projetista atribuído a este projeto.</p>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#atribuirProjetistaModal">
                  <i class="fas fa-user-plus me-1"></i> Atribuir Projetista
                </button>
              </div>
            {% endif %}
          </div>
        </div>
        -->
        
        <!-- Cronograma -->
        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">Cronograma</h6>
          </div>
          <div class="card-body p-0">
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><i class="fas fa-calendar-plus text-primary me-2"></i> Criação</span>
                <span>{{ projeto.created_at|date:"d/m/Y" }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><i class="fas fa-paper-plane {% if projeto.data_envio_briefing %}text-success{% else %}text-muted{% endif %} me-2"></i> Envio Briefing</span>
                <span>
                  {% if projeto.data_envio_briefing %}
                    {{ projeto.data_envio_briefing|date:"d/m/Y" }}
                  {% else %}
                    -
                  {% endif %}
                </span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><i class="fas fa-check-circle {% if projeto.data_aprovacao_projeto %}text-success{% else %}text-muted{% endif %} me-2"></i> Aprovação Projeto</span>
                <span>
                  {% if projeto.data_aprovacao_projeto %}
                    {{ projeto.data_aprovacao_projeto|date:"d/m/Y" }}
                  {% else %}
                    -
                  {% endif %}
                </span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><i class="fas fa-tools {% if projeto.data_inicio_producao %}text-success{% else %}text-muted{% endif %} me-2"></i> Início Produção</span>
                <span>
                  {% if projeto.data_inicio_producao %}
                    {{ projeto.data_inicio_producao|date:"d/m/Y" }}
                  {% else %}
                    -
                  {% endif %}
                </span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><i class="fas fa-check-double {% if projeto.data_entrega_estande %}text-success{% else %}text-muted{% endif %} me-2"></i> Entrega Estande</span>
                <span>
                  {% if projeto.data_entrega_estande %}
                    {{ projeto.data_entrega_estande|date:"d/m/Y" }}
                  {% else %}
                    -
                  {% endif %}
                </span>
              </li>
            </ul>
          </div>
        </div>
        
        <!-- Métricas -->
        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">Métricas</h6>
          </div>
          <div class="card-body p-0">
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><i class="fas fa-clock text-info me-2"></i> Tempo de Projeto</span>
                <span>
                  {% if projeto.tempo_projeto %}
                    {{ projeto.tempo_projeto }}
                  {% else %}
                    -
                  {% endif %}
                </span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><i class="fas fa-hourglass-half text-warning me-2"></i> Tempo de Produção</span>
                <span>
                  {% if projeto.tempo_producao %}
                    {{ projeto.tempo_producao }}
                  {% else %}
                    -
                  {% endif %}
                </span>
              </li>
            </ul>
          </div>
        </div>
        
        <!-- Mensagens Recentes -->
        <div class="card mb-3">
          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0">Mensagens Recentes</h6>
            <a href="{% url 'gestor:mensagens_projeto' projeto_id=projeto.id %}" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-envelope me-1"></i> Ver Todas
            </a>
          </div>
          <div class="card-body p-0">
            {% if mensagens %}
            <div class="list-group list-group-flush">
              {% for mensagem in mensagens %}
              <div class="list-group-item border-0 border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                  <small class="fw-bold">
                    {% if mensagem.remetente %}
                      {{ mensagem.remetente.get_full_name|default:mensagem.remetente.username }}
                    {% else %}
                      Usuário
                    {% endif %}
                  </small>
                  <small class="text-muted">{{ mensagem.data_envio|date:"d/m/Y H:i" }}</small>
                </div>
                <p class="mb-0 mt-1 small">{{ mensagem.conteudo|truncatechars:100 }}</p>
                {% if mensagem.anexos.exists %}
                <small class="text-muted"><i class="fas fa-paperclip me-1"></i> {{ mensagem.anexos.count }} anexo(s)</small>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-3">
              <i class="fas fa-comments fa-2x mb-3 text-muted"></i>
              <p>Nenhuma mensagem até o momento.</p>
              <a href="{% url 'gestor:mensagens_projeto' projeto_id=projeto.id %}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-plus me-1"></i> Nova Mensagem
              </a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="card-footer bg-light">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#alterarStatusModal">
          <i class="fas fa-tasks me-1"></i> Alterar Status
        </button>
        <a href="{% url 'gestor:mensagens_projeto' projeto_id=projeto.id %}" class="btn btn-outline-info ms-2">
          <i class="fas fa-comment me-1"></i> Mensagens
        </a>
      </div>
      <div>
        <a href="{% url 'gestor:projeto_list' %}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Modal para alterar status -->
<div class="modal fade" id="alterarStatusModal" tabindex="-1" aria-labelledby="alterarStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="alterarStatusModalLabel"><i class="fas fa-tasks me-2"></i> Alterar Status do Projeto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <form action="{% url 'gestor:projeto_alterar_status' pk=projeto.pk %}" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <p>Selecione o novo status para o projeto <strong>#{{ projeto.numero }}</strong>:</p>
          
          <div class="mb-3">
            <select name="status" class="form-select">
              {% for status_value, status_label in projeto.STATUS_CHOICES %}
              <option value="{{ status_value }}" {% if projeto.status == status_value %}selected{% endif %}>
                {{ status_label }}
              </option>
              {% endfor %}
            </select>
          </div>
          
          <div class="mb-3">
            <label for="observacao" class="form-label">Observação (opcional)</label>
            <textarea id="observacao" name="observacao" class="form-control" rows="3" placeholder="Explique o motivo da alteração de status..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Estilos adicionais -->
<style>
  /* Estilo para timeline de marcos */
  .timeline-container {
    position: relative;
    padding-left: 30px;
  }
  
  .timeline-item {
    position: relative;
  }
  
  .timeline-marker {
    position: absolute;
    left: -30px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    top: 4px;
  }
  
  .timeline-content {
    border-left: 1px solid #dee2e6;
    padding-left: 15px;
    padding-bottom: 15px;
  }
  
  .timeline-item:last-child .timeline-content {
    padding-bottom: 0;
    border-left: 1px solid transparent;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Excluir arquivo
  document.querySelectorAll('.excluir-arquivo').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (confirm('Tem certeza que deseja excluir este arquivo?')) {
        const url = this.getAttribute('data-url');
        if (url) {
          const item = this.closest('.arquivo-item') || this.closest('.list-group-item');
          
          fetch(url, {
            method: 'POST',
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
              'Content-Type': 'application/json'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              item.remove();
            } else {
              alert('Erro ao excluir arquivo: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir arquivo. Tente novamente.');
          });
        }
      }
    });
  });
});
</script>
{% endblock %}