{% extends 'gestor/base_gestor.html' %}

{% block title %}Projetos | Portal do Gestor{% endblock %}

{% block content %}
<div class="card shadow">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="fas fa-project-diagram me-2"></i> Projetos
    </h5>
    <a href="{% url 'gestor:dashboard' %}" class="btn btn-outline-secondary btn-sm">
      <i class="fas fa-arrow-left me-1"></i> Voltar
    </a>
  </div>
  
  <!-- Filtros -->
  <div class="card-header bg-white">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label small">Empresa</label>
        <select name="empresa" class="form-select form-select-sm">
          <option value="">Todas as Empresas</option>
          {% for empresa in empresas %}
          <option value="{{ empresa.id }}" {% if empresa_escolhida == empresa.id|stringformat:"s" %}selected{% endif %}>
            {{ empresa.nome }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <div class="col-md-3">
        <label class="form-label small">Feira</label>
        <select name="feira" class="form-select form-select-sm">
          <option value="">Todas as Feiras</option>
          {% for feira in feiras %}
          <option value="{{ feira.id }}" {% if feira_escolhida == feira.id|stringformat:"s" %}selected{% endif %}>
            {{ feira.nome }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <div class="col-md-3">
        <label class="form-label small">Status</label>
        <select name="status" class="form-select form-select-sm">
          <option value="">Todos os Status</option>
          {% for status_value, status_label in status_choices %}
          <option value="{{ status_value }}" {% if status_escolhido == status_value %}selected{% endif %}>
            {{ status_label }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <div class="col-md-3">
        <label class="form-label small">Busca</label>
        <div class="input-group input-group-sm">
          <input type="text" name="search" class="form-control" placeholder="Buscar..." value="{{ search_query|default:'' }}">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </div>
    </form>
  </div>
  
  <!-- Lista de Projetos -->
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col">Número</th>
            <th scope="col">Empresa</th>
            <th scope="col">Feira</th>
            <th scope="col">Status</th>
            <th scope="col">Briefing</th>
            <th scope="col">Aprovação</th>
            <th scope="col">Entrega</th>
            <th scope="col" class="text-end">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for projeto in projetos %}
          <tr>
            <td>{{ projeto.numero }}</td>
            <td>
              <span class="badge bg-secondary">{{ projeto.empresa.nome }}</span>
            </td>
            <td>
              {% if projeto.feira %}
                {{ projeto.feira.nome }}
              {% else %}
                <span class="text-muted">Não definida</span>
              {% endif %}
            </td>
            <td>
              <span class="badge 
                {% if projeto.status == 'briefing_pendente' %}bg-info
                {% elif projeto.status == 'briefing_validado' %}bg-success
                {% elif projeto.status == 'briefing_enviado' %}bg-info
                {% elif projeto.status == 'projeto_em_desenvolvimento' %}bg-primary
                {% elif projeto.status == 'projeto_enviado' %}bg-info
                {% elif projeto.status == 'projeto_em_analise' %}bg-warning text-dark
                {% elif projeto.status == 'projeto_aprovado' %}bg-success
                {% elif projeto.status == 'em_producao' %}bg-danger
                {% elif projeto.status == 'concluido' %}bg-secondary
                {% elif projeto.status == 'cancelado' %}bg-danger
                {% else %}bg-secondary{% endif %}">
                {{ projeto.get_status_display }}
              </span>
            </td>
            <td>
              {% if projeto.data_briefing %}
                {{ projeto.data_briefing|date:"d/m/Y" }}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              {% if projeto.data_aprovacao %}
                {{ projeto.data_aprovacao|date:"d/m/Y" }}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              {% if projeto.data_entrega %}
                {{ projeto.data_entrega|date:"d/m/Y" }}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td class="text-end">
              <td class="text-end">
                <div class="btn-group">
                  <a href="{% url 'gestor:projeto_detail' pk=projeto.pk %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye"></i>
                  </a>
                  
                  {% if projeto.has_briefing %}
                  {% with briefing=projeto.briefings.first %}
                    {% if briefing.pdf_file %}
                    <a href="{{ briefing.pdf_file.url }}" class="btn btn-sm btn-outline-success" target="_blank" title="Ver PDF do Briefing">
                      <i class="fas fa-file-pdf"></i>
                    </a>
                    {% else %}
                    <a href="{% url 'cliente:relatorio_briefing' projeto_id=projeto.id %}" class="btn btn-sm btn-outline-success" title="Gerar PDF do Briefing">
                      <i class="fas fa-sync-alt"></i>
                    </a>
                    {% endif %}
                  {% endwith %}
                {% endif %}
                  
                  <a href="{% url 'gestor:mensagens_projeto' projeto_id=projeto.id %}" class="btn btn-sm btn-outline-info">
                    <i class="fas fa-comment"></i>
                  </a>
                  
                  <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{% url 'gestor:projeto_detail' pk=projeto.pk %}">
                      <i class="fas fa-eye me-2"></i> Ver Detalhes
                    </a></li>
                    
                    <li><a class="dropdown-item" href="{% url 'gestor:mensagens_projeto' projeto_id=projeto.id %}">
                      <i class="fas fa-comment me-2"></i> Mensagens
                    </a></li>
                    
                    <li><hr class="dropdown-divider"></li>
                    
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#alterarStatusModal{{ projeto.id }}">
                      <i class="fas fa-exchange-alt me-2"></i> Alterar Status
                    </a></li>
                  </ul>
                </div>

              <!-- Modal para alterar status -->
              <div class="modal fade" id="alterarStatusModal{{ projeto.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Alterar Status do Projeto #{{ projeto.numero }}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <form action="{% url 'gestor:projeto_alterar_status' pk=projeto.pk %}" method="post">
                      {% csrf_token %}
                      <div class="modal-body">
                        <div class="mb-3">
                          <label class="form-label">Novo Status</label>
                          <select name="status" class="form-select">
                            {% for status_value, status_label in status_choices %}
                            <option value="{{ status_value }}" {% if projeto.status == status_value %}selected{% endif %}>
                              {{ status_label }}
                            </option>
                            {% endfor %}
                          </select>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Observação</label>
                          <textarea name="observacao" class="form-control" rows="3" placeholder="Opcional"></textarea>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center py-4">
              <div class="text-muted">
                <i class="fas fa-folder-open fa-2x mb-3"></i>
                <p>Nenhum projeto encontrado.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Paginação -->
  {% if projetos.paginator.num_pages > 1 %}
  <div class="card-footer bg-white">
    <nav aria-label="Navegação de páginas">
      <ul class="pagination pagination-sm justify-content-center mb-0">
        {% if projetos.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page=1&status={{ status_escolhido }}&empresa={{ empresa_escolhida }}&feira={{ feira_escolhida }}&search={{ search_query|urlencode }}">«</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ projetos.previous_page_number }}&status={{ status_escolhido }}&empresa={{ empresa_escolhida }}&feira={{ feira_escolhida }}&search={{ search_query|urlencode }}">‹</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">«</span></li>
          <li class="page-item disabled"><span class="page-link">‹</span></li>
        {% endif %}
        
        {% for i in projetos.paginator.page_range %}
          {% if projetos.number == i %}
            <li class="page-item active"><span class="page-link">{{ i }}</span></li>
          {% elif i > projetos.number|add:'-3' and i < projetos.number|add:'3' %}
            <li class="page-item">
              <a class="page-link" href="?page={{ i }}&status={{ status_escolhido }}&empresa={{ empresa_escolhida }}&feira={{ feira_escolhida }}&search={{ search_query|urlencode }}">{{ i }}</a>
            </li>
          {% endif %}
        {% endfor %}
        
        {% if projetos.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ projetos.next_page_number }}&status={{ status_escolhido }}&empresa={{ empresa_escolhida }}&feira={{ feira_escolhida }}&search={{ search_query|urlencode }}">›</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ projetos.paginator.num_pages }}&status={{ status_escolhido }}&empresa={{ empresa_escolhida }}&feira={{ feira_escolhida }}&search={{ search_query|urlencode }}">»</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">›</span></li>
          <li class="page-item disabled"><span class="page-link">»</span></li>
        {% endif %}
      </ul>
    </nav>
  </div>
  {% endif %}
</div>
{% endblock %}