{% load formatadores %}

<div class="card shadow">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="fas fa-clipboard-list me-2"></i> Briefing: {{ projeto.nome }}
    </h5>
    <div>
      {% if from_page == 'gestor' %}
        <a href="{% url 'gestor:projeto_detail' pk=projeto.pk %}" class="btn btn-outline-secondary btn-sm">
          <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
      {% elif from_page == 'projetista' %}
        <a href="{% url 'projetista:projeto_detail' pk=projeto.pk %}" class="btn btn-outline-secondary btn-sm">
          <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
      {% else %}
        <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm">
          <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
      {% endif %}
      
      {% if briefing.pdf_file %}
      <a href="{{ briefing.pdf_file.url }}" class="btn btn-outline-primary btn-sm ms-2" target="_blank">
        <i class="fas fa-file-pdf me-1"></i> Ver PDF
      </a>
      {% endif %}
    </div>
  </div>
  
  <div class="card-body">
    <!-- Informações para Gestores -->
    {% if from_page == 'gestor' and projetista_info %}
      <!-- Card com informações adicionais para o gestor -->
      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">Informações de Gestão</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6>Projetista Responsável</h6>
              <p>
                <strong>{{ projetista_info.nome }}</strong><br>
                {{ projetista_info.email }}<br>
                {% if projetista_info.telefone %}
                  {{ projetista_info.telefone }}
                {% endif %}
              </p>
            </div>
            <div class="col-md-6">
              <h6>Datas Importantes</h6>
              <p>
                <strong>Criado em:</strong> {{ info_gestao.data_criacao|date:"d/m/Y H:i" }}<br>
                <strong>Última atualização:</strong> {{ info_gestao.data_ultima_atualizacao|date:"d/m/Y H:i" }}<br>
                {% if info_gestao.data_envio_briefing %}
                  <strong>Briefing enviado em:</strong> {{ info_gestao.data_envio_briefing|date:"d/m/Y H:i" }}<br>
                {% endif %}
                {% if info_gestao.data_limite %}
                  <strong>Data limite:</strong> {{ info_gestao.data_limite|date:"d/m/Y" }}
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  
    <!-- Seletor de versão -->
    {% if briefings.count > 1 %}
    <div class="mb-3">
      <label class="form-label fw-bold">Versão do Briefing</label>
      <select id="versaoSelect" class="form-select" onchange="redirectToVersion(this.value)">
        {% for b in briefings %}
        <option value="{{ b.versao }}" {% if b.id == briefing.id %}selected{% endif %}>
          v{{ b.versao }} - {{ b.updated_at|date:"d/m/Y H:i" }} ({{ b.get_status_display }})
        </option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

        
    <!-- Resumo do Briefing -->
    <div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Resumo do Briefing</h5>
    </div>
    <div class="card-body">
        <div class="row">
        <!-- Status do Briefing -->
        <div class="col-md-6">
            <div class="card h-100">
            <div class="card-header bg-light">
                <h6 class="mb-0">Status do Briefing</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                <strong>Status Atual:</strong> 
                <span class="badge 
                    {% if briefing.status == 'rascunho' %}bg-secondary
                    {% elif briefing.status == 'em_validacao' %}bg-primary
                    {% elif briefing.status == 'validado' %}bg-info
                    {% elif briefing.status == 'enviado' %}bg-info
                    {% elif briefing.status == 'revisao' %}bg-warning
                    {% elif briefing.status == 'aprovado' %}bg-success
                    {% else %}bg-secondary{% endif %}">
                    {% if briefing.status == 'enviado' %}Briefing Enviado para Aprovação
                    {% elif briefing.status == 'revisao' %}Aguardando Ajustes do Cliente
                    {% elif briefing.status == 'aprovado' %}Briefing Aprovado
                    {% else %}{{ briefing.get_status_display }}
                    {% endif %}
                </span>
                </div>
                <div class="mb-2">
                <strong>Progresso:</strong> {{ briefing.progresso }}%
                </div>
                <div>
                <strong>Última Atualização:</strong> {{ briefing.updated_at|date:"d/m/Y H:i" }}
                </div>
            </div>
            </div>
        </div>
        
        <!-- Dados do Briefing -->
        <div class="col-md-6">
            <div class="card h-100">
            <div class="card-header bg-light">
                <h6 class="mb-0">Dados do Projeto</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                <strong>Cliente:</strong> {{ projeto.empresa.nome }}
                </div>

                {% if projeto.empresa.descricao %}
                <div class="mb-2">
                <strong>Sobre a Empresa:</strong> 
                <small class="text-muted d-block">{{ projeto.empresa.descricao|truncatechars:150 }}</small>
                </div>
                {% endif %}

                <div class="mb-2">
                <strong>Nome do Projeto:</strong> {{ projeto.nome }}
                </div>
                <div class="mb-2">
                <strong>Tipo de Projeto:</strong> 
                <span class="badge bg-primary">{{ projeto.get_tipo_projeto_display }}</span>
                </div>
                

                <div class="mb-2">
                <strong>Objetivo do Projeto:</strong> 
                {% if projeto.descricao %}
                    <small class="text-muted d-block">{{ projeto.descricao|truncatechars:150 }}</small>
                {% else %}
                    <small class="text-muted">Não informado</small>
                {% endif %}
                </div>
                

                <div class="mb-2">
                <strong>Orçamento:</strong> 
                {% if briefing.orcamento %}
                    R$ {{ briefing.orcamento|moeda_brasileira }}
                {% else %}
                    Não informado
                {% endif %}
                </div>

            </div>
            </div>
        </div>
        </div>
    </div>
    </div>

    
    <!-- Abas para diferentes seções -->
    <ul class="nav nav-tabs mb-4 mt-4" id="briefingTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="evento-tab" data-bs-toggle="tab" data-bs-target="#evento" type="button" role="tab" aria-controls="evento" aria-selected="true">
          1. Local Estande
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="estande-tab" data-bs-toggle="tab" data-bs-target="#estande" type="button" role="tab" aria-controls="estande" aria-selected="false">
          2. Características
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="areas-tab" data-bs-toggle="tab" data-bs-target="#areas" type="button" role="tab" aria-controls="areas" aria-selected="false">
          3. Divisões
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="complementares-tab" data-bs-toggle="tab" data-bs-target="#complementares" type="button" role="tab" aria-controls="complementares" aria-selected="false">
          4. Referências Visuais
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab" aria-controls="chat" aria-selected="false">
          Conversas <span class="badge bg-primary rounded-pill ms-1">{{ conversas.count }}</span>
        </button>
      </li>

    </ul>
    
    <!-- Conteúdo das abas -->
    <div class="tab-content" id="briefingTabContent">
      <!-- 1. EVENTO - Datas e Localização -->
      <div class="tab-pane fade show active" id="evento" role="tabpanel" aria-labelledby="evento-tab">
        <div class="row g-4">
          <!-- Informações da Feira ou Evento -->
          <div class="col-12">
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0">Informações do {% if projeto.feira or briefing.feira %}Evento/Feira{% else %}Evento{% endif %}</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  {% if projeto.feira or briefing.feira %}
                  <!-- Campos para projetos com feira -->
                  {% with feira=briefing.feira|default:projeto.feira %}
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Feira/Evento</label>
                    <div class="p-2 bg-light rounded">{{ feira.nome|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Local</label>
                    <div class="p-2 bg-light rounded">{{ feira.local|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Cidade/UF</label>
                    <div class="p-2 bg-light rounded">
                      {% if feira.cidade %}
                        {{ feira.cidade }}/{{ feira.estado|default:"--" }}
                      {% else %}
                        Não informado
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Organizador</label>
                    <div class="p-2 bg-light rounded">{{ feira.promotora|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Período do Evento</label>
                    <div class="p-2 bg-light rounded">
                      {% if feira.data_inicio %}
                        {{ feira.data_inicio|date:"d/m/Y" }} a {{ feira.data_fim|date:"d/m/Y"|default:"--" }}
                      {% else %}
                        Não informado
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Horário</label>
                    <div class="p-2 bg-light rounded">{{ feira.data_horario|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Período de Montagem</label>
                    <div class="p-2 bg-light rounded">{{ feira.periodo_montagem|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Período de Desmontagem</label>
                    <div class="p-2 bg-light rounded">{{ feira.periodo_desmontagem|default:"Não informado" }}</div>
                  </div>
                  {% endwith %}
                  
                  {% else %}
                  <!-- Campos para projetos do tipo "outros" -->
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Evento</label>
                    <div class="p-2 bg-light rounded">{{ briefing.nome_evento|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Local</label>
                    <div class="p-2 bg-light rounded">{{ briefing.local_evento|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Organizador</label>
                    <div class="p-2 bg-light rounded">{{ briefing.organizador_evento|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Data e Horário</label>
                    <div class="p-2 bg-light rounded">{{ briefing.data_horario_evento|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Período de Montagem</label>
                    <div class="p-2 bg-light rounded">{{ briefing.periodo_montagem_evento|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Período de Desmontagem</label>
                    <div class="p-2 bg-light rounded">{{ briefing.periodo_desmontagem_evento|default:"Não informado" }}</div>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Localização do Estande -->
          <div class="col-12">
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0">Localização do Estande</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-12">
                    <label class="form-label fw-bold text-primary">Endereço do Estande</label>
                    <div class="p-2 bg-light rounded">{{ briefing.endereco_estande|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-12">
                    <label class="form-label fw-bold text-primary">Mapa do Estande</label>
                    {% if mapa_arquivo %}
                      <div class="mt-2">
                        <a href="{{ mapa_arquivo.arquivo.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                          <i class="fas fa-file me-1"></i> Ver Mapa
                        </a>
                        
                        <!-- Prévia do mapa se for imagem -->
                        {% with arquivo_url=mapa_arquivo.arquivo.url|lower %}
                          {% if '.jpg' in arquivo_url or '.jpeg' in arquivo_url or '.png' in arquivo_url or '.gif' in arquivo_url or '.svg' in arquivo_url or '.webp' in arquivo_url %}
                            <div class="mt-3">
                              <img src="{{ mapa_arquivo.arquivo.url }}" alt="Mapa do Estande" class="img-fluid img-thumbnail" style="max-height: 300px;">
                            </div>
                          {% endif %}
                        {% endwith %}
                      </div>
                    {% else %}
                      <div class="p-2 bg-light rounded">Não enviado</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 2. ESTANDE - Características Físicas -->
      <div class="tab-pane fade" id="estande" role="tabpanel" aria-labelledby="estande-tab">
        <div class="row g-4">
          <!-- Informações do Estande -->
          <div class="col-12">
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0">Informações do Estande</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <!-- Planta do Estande -->
                  <div class="col-md-12 mb-3">
                    <label class="form-label fw-bold text-primary">Planta / Esboço</label>
                    <div class="row">
                      {% for arquivo in planta_arquivos %}
                        <div class="col-md-6 mb-3">
                          {% with arquivo_url=arquivo.arquivo.url|lower %}
                            {% if '.jpg' in arquivo_url or '.jpeg' in arquivo_url or '.png' in arquivo_url or '.gif' in arquivo_url or '.svg' in arquivo_url or '.webp' in arquivo_url %}
                              <div class="mb-2">
                                <img src="{{ arquivo.arquivo.url }}" alt="Planta do Estande" class="img-fluid img-thumbnail" style="max-height: 200px;">
                              </div>
                            {% else %}
                              <div class="mb-2">
                                <i class="fas fa-drafting-compass fa-3x text-primary"></i>
                              </div>
                            {% endif %}
                          {% endwith %}
                          <a href="{{ arquivo.arquivo.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                            <i class="fas fa-download me-1"></i> Ver Planta
                          </a>
                        </div>
                      {% empty %}
                        <div class="col-12">
                          <div class="p-2 bg-light rounded">Nenhuma planta enviada.</div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                  
                  <div class="col-md-3">
                    <label class="form-label fw-bold text-primary">Medida Frente (m)</label>
                    <div class="p-2 bg-light rounded">{{ briefing.medida_frente|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-3">
                    <label class="form-label fw-bold text-primary">Medida Fundo (m)</label>
                    <div class="p-2 bg-light rounded">{{ briefing.medida_fundo|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-3">
                    <label class="form-label fw-bold text-primary">Lateral Esquerda (m)</label>
                    <div class="p-2 bg-light rounded">{{ briefing.medida_lateral_esquerda|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-3">
                    <label class="form-label fw-bold text-primary">Lateral Direita (m)</label>
                    <div class="p-2 bg-light rounded">{{ briefing.medida_lateral_direita|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-4">
                    <label class="form-label fw-bold text-primary">Área Total (m²)</label>
                    <div class="p-2 bg-light rounded">{{ briefing.area_estande|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-4">
                    <label class="form-label fw-bold text-primary">Materiais</label>
                    <div class="p-2 bg-light rounded">{{ briefing.get_material_display|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-4">
                    <label class="form-label fw-bold text-primary">Tipo de Estande</label>
                    <div class="p-2 bg-light rounded">{{ briefing.get_tipo_stand_display|default:"Não informado" }}</div>
                    
                    {% if briefing.tipo_stand %}
                    <div class="text-center mt-2">
                      <img src="/static/img/stands/{{ briefing.tipo_stand }}.png" 
                           alt="{{ briefing.get_tipo_stand_display }}" 
                           style="max-height: 150px; max-width: 100%;" 
                           class="img-thumbnail">
                    </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-12">
                    <label class="form-label fw-bold text-primary">Estilo do Estande</label>
                    <div class="p-2 bg-light rounded">{{ briefing.estilo_estande|default:"Não informado" }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Estrutura do Estande -->
          <div class="col-12">
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0">Estrutura do Estande</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Piso Elevado</label>
                    <div class="p-2 bg-light rounded">{{ briefing.get_piso_elevado_display|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-bold text-primary">Tipo Testeira</label>
                    <div class="p-2 bg-light rounded">{{ briefing.get_tipo_testeira_display|default:"Não informado" }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Funcionalidades / Objetivo do Estande -->
          <div class="col-12">
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0">Funcionalidades</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label fw-bold text-primary">Venda</label>
                    <div class="p-2 bg-light rounded">{{ briefing.get_tipo_venda_display|default:"Não informado" }}</div>
                  </div>
                  
                  <div class="col-md-8">
                    <label class="form-label fw-bold text-primary">Tipo de Ativação</label>
                    <div class="p-2 bg-light rounded">{{ briefing.tipo_ativacao|default:"Não informado" }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
    <!-- 3. ÁREAS DO ESTANDE - Divisões Funcionais -->
    <div class="tab-pane fade" id="areas" role="tabpanel" aria-labelledby="areas-tab">
    <div class="row g-4">
        <!-- Áreas de Exposição (Atendimento) -->
        <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-light">
            <h6 class="mb-0">Áreas de Atendimento</h6>
            </div>
            <div class="card-body">
            {% if areas_exposicao %}
                <div class="accordion" id="accordionAreasExposicao">
                {% for area in areas_exposicao %}
                    <div class="accordion-item">
                    <h2 class="accordion-header" id="headingArea{{ forloop.counter }}">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#collapseArea{{ forloop.counter }}" 
                            aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="collapseArea{{ forloop.counter }}">
                        Área de Atendimento {{ forloop.counter }} 
                        </button>
                    </h2>
                    <div id="collapseArea{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                        aria-labelledby="headingArea{{ forloop.counter }}" data-bs-parent="#accordionAreasExposicao">
                        <div class="accordion-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                            <label class="form-label fw-bold text-primary">Metragem</label>
                            <div class="p-2 bg-light rounded">
                                {% if area.metragem and area.metragem > 0 %}{{ area.metragem }} m²{% else %}Não informada{% endif %}
                            </div>
                            </div>
                            
                            <div class="col-md-8">
                            <label class="form-label fw-bold text-primary">Itens</label>
                            <ul class="list-group mb-3">
                                {% if area.tem_lounge %}<li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i> Lounge</li>{% endif %}
                                {% if area.tem_vitrine_exposicao %}<li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i> Vitrine Exposição</li>{% endif %}
                                {% if area.tem_balcao_recepcao %}<li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i> Balcão Recepção</li>{% endif %}
                                {% if area.tem_mesas_atendimento %}<li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i> Mesas de Atendimento</li>{% endif %}
                                {% if area.tem_balcao_cafe %}<li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i> Balcão para Café/Bar</li>{% endif %}
                                {% if area.tem_balcao_vitrine %}<li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i> Balcão Vitrine</li>{% endif %}
                                {% if area.tem_caixa_vendas %}<li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i> Caixa para Vendas</li>{% endif %}
                                {% if not area.tem_lounge and not area.tem_vitrine_exposicao and not area.tem_balcao_recepcao and not area.tem_mesas_atendimento and not area.tem_balcao_cafe and not area.tem_balcao_vitrine and not area.tem_caixa_vendas %}
                                <li class="list-group-item text-muted">Nenhum item selecionado</li>
                                {% endif %}
                            </ul>
                            </div>
                            
                            <div class="col-md-6">
                            <label class="form-label fw-bold text-primary">Equipamentos</label>
                            <div class="p-3 bg-light rounded">
                                {{ area.equipamentos|linebreaks|default:"Não informado" }}
                            </div>
                            </div>
                            
                            <div class="col-md-6">
                            <label class="form-label fw-bold text-primary">Observações</label>
                            <div class="p-3 bg-light rounded">
                                {{ area.observacoes|linebreaks|default:"Não informado" }}
                            </div>
                            </div>
                        </div>
                        </div>
                    </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info mb-0">
                Nenhuma área de atendimento configurada.
                </div>
            {% endif %}
            </div>
        </div>
        </div>

        <!-- Salas de Reunião -->
        <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-light">
            <h6 class="mb-0">Salas de Reunião</h6>
            </div>
            <div class="card-body">
            {% if salas_reuniao %}
                <div class="accordion" id="accordionSalasReuniao">
                {% for sala in salas_reuniao %}
                    <div class="accordion-item">
                    <h2 class="accordion-header" id="headingSala{{ forloop.counter }}">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#collapseSala{{ forloop.counter }}" 
                            aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="collapseSala{{ forloop.counter }}">
                        Sala de Reunião {{ forloop.counter }}
                        </button>
                    </h2>
                    <div id="collapseSala{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                        aria-labelledby="headingSala{{ forloop.counter }}" data-bs-parent="#accordionSalasReuniao">
                        <div class="accordion-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                            <label class="form-label fw-bold text-primary">Capacidade</label>
                            <div class="p-2 bg-light rounded">{{ sala.capacidade }} pessoas</div>
                            </div>
                            
                            <!-- NOVO CAMPO -->
                            <div class="col-md-4">
                            <label class="form-label fw-bold text-primary">Tipo de Sala</label>
                            <div class="p-2 bg-light rounded">
                                <span class="badge {% if sala.tipo_sala == 'fechada' %}bg-info{% else %}bg-success{% endif %}">
                                {{ sala.get_tipo_sala_display|default:"Não informado" }}
                                </span>
                            </div>
                            </div>
                            
                            <div class="col-md-4">
                            <label class="form-label fw-bold text-primary">Metragem</label>
                            <div class="p-2 bg-light rounded">
                                {% if sala.metragem and sala.metragem > 0 %}{{ sala.metragem }} m²{% else %}Não informada{% endif %}
                            </div>
                            </div>
                            
                            <div class="col-md-12">
                            <label class="form-label fw-bold text-primary">Equipamentos</label>
                            <div class="p-3 bg-light rounded">
                                {{ sala.equipamentos|linebreaks|default:"Não informado" }}
                            </div>
                            </div>
                        </div>
                        </div>
                    </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info mb-0">
                Nenhuma sala de reunião configurada.
                </div>
            {% endif %}
            </div>
        </div>
        </div>
        
        <!-- PALCOS - NOVA SEÇÃO -->
        <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-light">
            <h6 class="mb-0">Palcos</h6>
            </div>
            <div class="card-body">
            {% if briefing.palcos.all %}
                <div class="accordion" id="accordionPalcos">
                {% for palco in briefing.palcos.all %}
                    <div class="accordion-item">
                    <h2 class="accordion-header" id="headingPalco{{ forloop.counter }}">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#collapsePalco{{ forloop.counter }}" 
                            aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="collapsePalco{{ forloop.counter }}">
                        Palco {{ forloop.counter }}
                        </button>
                    </h2>
                    <div id="collapsePalco{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                        aria-labelledby="headingPalco{{ forloop.counter }}" data-bs-parent="#accordionPalcos">
                        <div class="accordion-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                            <label class="form-label fw-bold text-primary">Metragem</label>
                            <div class="p-2 bg-light rounded">
                                {% if palco.metragem and palco.metragem > 0 %}{{ palco.metragem }} m²{% else %}Não informada{% endif %}
                            </div>
                            </div>
                            
                            <div class="col-md-8">
                            <label class="form-label fw-bold text-primary">Componentes do Palco</label>
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                {% if palco.tem_elevacao_podium %}<span class="badge bg-warning text-dark">🏛️ Elevação/Pódium</span>{% endif %}
                                {% if palco.tem_sistema_som %}<span class="badge bg-warning text-dark">🔊 Sistema de Som</span>{% endif %}
                                {% if palco.tem_microfone %}<span class="badge bg-warning text-dark">🎤 Microfone</span>{% endif %}
                                {% if palco.tem_telao_tv %}<span class="badge bg-warning text-dark">📺 Telão/TV</span>{% endif %}
                                {% if palco.tem_iluminacao_cenica %}<span class="badge bg-warning text-dark">💡 Iluminação Cênica</span>{% endif %}
                                {% if palco.tem_backdrop_cenario %}<span class="badge bg-warning text-dark">🎨 Backdrop/Cenário</span>{% endif %}
                                {% if palco.tem_bancada_demonstracao %}<span class="badge bg-warning text-dark">🧪 Bancada Demonstração</span>{% endif %}
                                {% if palco.tem_espaco_plateia %}<span class="badge bg-warning text-dark">🪑 Espaço Plateia</span>{% endif %}
                                {% if not palco.tem_elevacao_podium and not palco.tem_sistema_som and not palco.tem_microfone and not palco.tem_telao_tv and not palco.tem_iluminacao_cenica and not palco.tem_backdrop_cenario and not palco.tem_bancada_demonstracao and not palco.tem_espaco_plateia %}
                                <span class="text-muted">Nenhum componente específico selecionado</span>
                                {% endif %}
                            </div>
                            </div>
                            
                            {% if palco.equipamentos %}
                            <div class="col-md-6">
                            <label class="form-label fw-bold text-primary">Equipamentos Específicos</label>
                            <div class="p-3 bg-light rounded">
                                {{ palco.equipamentos|linebreaks }}
                            </div>
                            </div>
                            {% endif %}
                            
                            {% if palco.observacoes %}
                            <div class="col-md-6">
                            <label class="form-label fw-bold text-primary">Observações</label>
                            <div class="p-3 bg-light rounded">
                                {{ palco.observacoes|linebreaks }}
                            </div>
                            </div>
                            {% endif %}
                        </div>
                        </div>
                    </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle me-2"></i>Nenhum palco configurado.
                </div>
            {% endif %}
            </div>
        </div>
        </div>
        
        <!-- WORKSHOPS - NOVA SEÇÃO -->
        <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-light">
            <h6 class="mb-0">Workshops</h6>
            </div>
            <div class="card-body">
            {% if briefing.workshops.all %}
                <div class="accordion" id="accordionWorkshops">
                {% for workshop in briefing.workshops.all %}
                    <div class="accordion-item">
                    <h2 class="accordion-header" id="headingWorkshop{{ forloop.counter }}">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#collapseWorkshop{{ forloop.counter }}" 
                            aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="collapseWorkshop{{ forloop.counter }}">
                        Workshop {{ forloop.counter }}
                        </button>
                    </h2>
                    <div id="collapseWorkshop{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                        aria-labelledby="headingWorkshop{{ forloop.counter }}" data-bs-parent="#accordionWorkshops">
                        <div class="accordion-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                            <label class="form-label fw-bold text-primary">Metragem</label>
                            <div class="p-2 bg-light rounded">
                                {% if workshop.metragem and workshop.metragem > 0 %}{{ workshop.metragem }} m²{% else %}Não informada{% endif %}
                            </div>
                            </div>
                            
                            <div class="col-md-8">
                            <label class="form-label fw-bold text-primary">Equipamentos do Workshop</label>
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                {% if workshop.tem_bancada_trabalho %}<span class="badge bg-success">🔨 Bancada de Trabalho</span>{% endif %}
                                {% if workshop.tem_mesas_participantes %}<span class="badge bg-success">🪑 Mesas Participantes</span>{% endif %}
                                {% if workshop.tem_cadeiras_bancos %}<span class="badge bg-success">💺 Cadeiras/Bancos</span>{% endif %}
                                {% if workshop.tem_quadro_flipchart %}<span class="badge bg-success">📝 Quadro/Flipchart</span>{% endif %}
                                {% if workshop.tem_projetor_tv %}<span class="badge bg-success">📽️ Projetor/TV</span>{% endif %}
                                {% if workshop.tem_pia_bancada_molhada %}<span class="badge bg-success">🚿 Pia/Bancada Molhada</span>{% endif %}
                                {% if workshop.tem_armario_materiais %}<span class="badge bg-success">🗄️ Armário Materiais</span>{% endif %}
                                {% if workshop.tem_pontos_eletricos_extras %}<span class="badge bg-success">⚡ Pontos Elétricos Extras</span>{% endif %}
                                {% if not workshop.tem_bancada_trabalho and not workshop.tem_mesas_participantes and not workshop.tem_cadeiras_bancos and not workshop.tem_quadro_flipchart and not workshop.tem_projetor_tv and not workshop.tem_pia_bancada_molhada and not workshop.tem_armario_materiais and not workshop.tem_pontos_eletricos_extras %}
                                <span class="text-muted">Nenhum equipamento específico selecionado</span>
                                {% endif %}
                            </div>
                            </div>
                            
                            {% if workshop.equipamentos %}
                            <div class="col-md-6">
                            <label class="form-label fw-bold text-primary">Equipamentos Adicionais</label>
                            <div class="p-3 bg-light rounded">
                                {{ workshop.equipamentos|linebreaks }}
                            </div>
                            </div>
                            {% endif %}
                            
                            {% if workshop.observacoes %}
                            <div class="col-md-6">
                            <label class="form-label fw-bold text-primary">Observações</label>
                            <div class="p-3 bg-light rounded">
                                {{ workshop.observacoes|linebreaks }}
                            </div>
                            </div>
                            {% endif %}
                        </div>
                        </div>
                    </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle me-2"></i>Nenhum workshop configurado.
                </div>
            {% endif %}
            </div>
        </div>
        </div>
 

        <!-- Salas de Reunião -->
        <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-light">
            <h6 class="mb-0">Salas de Reunião</h6>
            </div>
            <div class="card-body">
            {% if salas_reuniao %}
                <div class="accordion" id="accordionSalasReuniao">
                {% for sala in salas_reuniao %}
                    <div class="accordion-item">
                    <h2 class="accordion-header" id="headingSala{{ forloop.counter }}">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#collapseSala{{ forloop.counter }}" 
                            aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="collapseSala{{ forloop.counter }}">
                        Sala de Reunião {{ forloop.counter }}
                        </button>
                    </h2>
                    <div id="collapseSala{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                        aria-labelledby="headingSala{{ forloop.counter }}" data-bs-parent="#accordionSalasReuniao">
                        <div class="accordion-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                            <label class="form-label fw-bold text-primary">Capacidade</label>
                            <div class="p-2 bg-light rounded">{{ sala.capacidade }} pessoas</div>
                            </div>
                            
                            <!-- NOVO CAMPO -->
                            <div class="col-md-4">
                            <label class="form-label fw-bold text-primary">Tipo de Sala</label>
                            <div class="p-2 bg-light rounded">
                                <span class="badge {% if sala.tipo_sala == 'fechada' %}bg-info{% else %}bg-success{% endif %}">
                                {{ sala.get_tipo_sala_display|default:"Não informado" }}
                                </span>
                            </div>
                            </div>
                            
                            <div class="col-md-4">
                            <label class="form-label fw-bold text-primary">Metragem</label>
                            <div class="p-2 bg-light rounded">
                                {% if sala.metragem and sala.metragem > 0 %}{{ sala.metragem }} m²{% else %}Não informada{% endif %}
                            </div>
                            </div>
                            
                            <div class="col-md-12">
                            <label class="form-label fw-bold text-primary">Equipamentos</label>
                            <div class="p-3 bg-light rounded">
                                {{ sala.equipamentos|linebreaks|default:"Não informado" }}
                            </div>
                            </div>
                        </div>
                        </div>
                    </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info mb-0">
                Nenhuma sala de reunião configurada.
                </div>
            {% endif %}
            </div>
        </div>
        </div>

        <!-- Copa -->
        <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-light">
            <h6 class="mb-0">Copa</h6>
            </div>
            <div class="card-body">
            {% if copas %}
                {% for copa in copas %}
                <div class="row g-3 {% if not forloop.last %}mb-4 pb-3 border-bottom{% endif %}">
                <div class="col-md-4">
                    <label class="form-label fw-bold text-primary">Metragem</label>
                    <div class="p-2 bg-light rounded">
                    {% if copa.metragem and copa.metragem > 0 %}{{ copa.metragem }} m²{% else %}Não informada{% endif %}
                    </div>
                </div>
                
                <div class="col-md-8">
                    <label class="form-label fw-bold text-primary">Equipamentos</label>
                    <div class="p-3 bg-light rounded">
                    {{ copa.equipamentos|linebreaks|default:"Não informado" }}
                    </div>
                </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle me-2"></i>Nenhuma copa configurada.
                </div>
            {% endif %}
            </div>
        </div>
        </div>
        
        <!-- Depósito -->
        <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-light">
            <h6 class="mb-0">Depósito</h6>
            </div>
            <div class="card-body">
            {% if depositos %}
                {% for deposito in depositos %}
                <div class="row g-3 {% if not forloop.last %}mb-4 pb-3 border-bottom{% endif %}">
                <div class="col-md-4">
                    <label class="form-label fw-bold text-primary">Metragem</label>
                    <div class="p-2 bg-light rounded">
                    {% if deposito.metragem and deposito.metragem > 0 %}{{ deposito.metragem }} m²{% else %}Não informada{% endif %}
                    </div>
                </div>
                
                <div class="col-md-8">
                    <label class="form-label fw-bold text-primary">Equipamentos</label>
                    <div class="p-3 bg-light rounded">
                    {{ deposito.equipamentos|linebreaks|default:"Não informado" }}
                    </div>
                </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle me-2"></i>Nenhum depósito configurado.
                </div>
            {% endif %}
            </div>
        </div>
        </div>
    </div>
    </div>
      
      <!-- 4. DADOS COMPLEMENTARES - Referências Visuais -->
      <div class="tab-pane fade" id="complementares" role="tabpanel" aria-labelledby="complementares-tab">
        <div class="row g-4">
          <!-- Referências Visuais -->
          <div class="col-12">
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0">🎨 Referências Visuais</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-12">
                    <label class="form-label fw-bold text-primary">Detalhamento</label>
                    <div class="p-3 bg-light rounded">
                      {{ briefing.referencias_dados|linebreaks|default:"Não informado" }}
                    </div>
                  </div>
                  
                  <!-- Arquivos de Referência -->
                  <div class="col-md-12">
                    <label class="form-label fw-bold text-primary">Arquivos de Referência</label>
                    <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3 mt-1">
                      {% for arquivo in referencia_arquivos %}
                        <div class="col">
                          <div class="card h-100">
                            <img src="{{ arquivo.arquivo.url }}" class="card-img-top" alt="{{ arquivo.nome }}" style="height: 150px; object-fit: cover;">
                            <div class="card-body p-2">
                              <h6 class="card-title text-truncate small">{{ arquivo.nome }}</h6>
                              <a href="{{ arquivo.arquivo.url }}" class="btn btn-sm btn-outline-primary mt-1" target="_blank">
                                <i class="fas fa-search me-1"></i> Ver
                              </a>
                            </div>
                          </div>
                        </div>
                      {% empty %}
                        <div class="col-12">
                          <div class="alert alert-light">Nenhum arquivo de referência enviado.</div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Materiais de Campanha -->
          <div class="col-12">
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0">📢 Materiais de Campanha</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-12">
                    <label class="form-label fw-bold text-primary">Detalhamento</label>
                    <div class="p-3 bg-light rounded">
                      {{ briefing.campanha_dados|linebreaks|default:"Não informado" }}
                    </div>
                  </div>
                  
                  <!-- Arquivos de Campanha -->
                  <div class="col-md-12">
                    <label class="form-label fw-bold text-primary">Arquivos de Campanha</label>
                    <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3 mt-1">
                      {% for arquivo in campanha_arquivos %}
                        <div class="col">
                          <div class="card h-100">
                            <img src="{{ arquivo.arquivo.url }}" class="card-img-top" alt="{{ arquivo.nome }}" style="height: 150px; object-fit: cover;">
                            <div class="card-body p-2">
                              <h6 class="card-title text-truncate small">{{ arquivo.nome }}</h6>
                              <a href="{{ arquivo.arquivo.url }}" class="btn btn-sm btn-outline-primary mt-1" target="_blank">
                                <i class="fas fa-search me-1"></i> Ver
                              </a>
                            </div>
                          </div>
                        </div>
                      {% empty %}
                        <div class="col-12">
                          <div class="alert alert-light">Nenhum arquivo de campanha enviado.</div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        <!-- Informações Complementares -->
        <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-light">
            <h6 class="mb-0">ℹ️ Informações Complementares</h6>
            </div>
            <div class="card-body">
            <div class="row g-3">
                <div class="col-md-12">
                <label class="form-label fw-bold text-primary">Detalhamento</label>
                <div class="p-3 bg-light rounded">
                    {{ briefing.logotipo|linebreaks|default:"Não informado" }}
                </div>
                </div>
                
                <!-- Outros Arquivos -->
                <div class="col-md-12">
                <label class="form-label fw-bold text-primary">Outros Arquivos</label>
                <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3 mt-1">
                    {% for arquivo in outros_arquivos %}
                    <div class="col">
                        <div class="card h-100">
                            <img src="{{ arquivo.arquivo.url }}" class="card-img-top" alt="{{ arquivo.nome }}" style="height: 150px; object-fit: cover;">
                            <div class="card-body p-2">
                              <h6 class="card-title text-truncate small">{{ arquivo.nome }}</h6>
                              <a href="{{ arquivo.arquivo.url }}" class="btn btn-sm btn-outline-primary mt-1" target="_blank">
                                <i class="fas fa-search me-1"></i> Ver
                              </a>
                            </div>
                        </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <div class="alert alert-light">Nenhum arquivo adicional enviado.</div>
                    </div>
                    {% endfor %}
                </div>
                </div>
            </div>
            </div>
        </div>
        </div>          
        </div>
      </div>
            
     
     <!-- Conversas -->
     <div class="tab-pane fade" id="chat" role="tabpanel" aria-labelledby="chat-tab">
       <div class="chat-container p-3 bg-light rounded" style="max-height: 500px; overflow-y: auto;">
         {% if conversas %}
           {% for conversa in conversas %}
             <div class="chat-message mb-3">
               <div class="d-flex align-items-center mb-1">
                 <div class="{% if conversa.origem == 'cliente' %}bg-info{% elif conversa.origem == 'ia' %}bg-warning text-dark{% else %}bg-success{% endif %} rounded-circle d-flex align-items-center justify-content-center text-white" style="width: 30px; height: 30px; font-size: 0.8rem;">
                   {{ conversa.origem|slice:":1"|upper }}
                 </div>
                 <span class="ms-2 fw-medium">
                   {% if conversa.origem == 'cliente' %}
                     Cliente
                   {% elif conversa.origem == 'ia' %}
                     Assistente IA
                   {% else %}
                     Equipe Afinal
                   {% endif %}
                   {% if conversa.etapa %}<span class="text-muted">(Etapa {{ conversa.etapa }})</span>{% endif %}
                 </span>
                 <small class="text-muted ms-auto">{{ conversa.timestamp|date:"d/m/Y H:i" }}</small>
               </div>
               <div class="chat-bubble {% if conversa.origem == 'cliente' %}bg-white{% elif conversa.origem == 'ia' %}bg-light-warning{% else %}bg-light-success{% endif %} border rounded p-3">
                 {{ conversa.mensagem|linebreaks }}
               </div>
             </div>
           {% endfor %}
         {% else %}
           <div class="text-center py-4">
             <i class="fas fa-comments fa-2x mb-3 text-muted"></i>
             <p>Nenhuma conversa registrada durante o preenchimento do briefing.</p>
           </div>
         {% endif %}
       </div>
     </div>
     
   </div>
 </div>
</div>

<style>
.chat-message {
 max-width: 90%;
 margin-bottom: 15px;
}

.chat-bubble {
 border-radius: 15px;
 position: relative;
 display: inline-block;
 max-width: 100%;
 border: 1px solid #dee2e6;
}

.bg-light-success {
 background-color: #f0f9f4;
}

.bg-light-warning {
 background-color: #fff8e1;
}
</style>

<script>
// Função para redirecionar com base na versão selecionada
function redirectToVersion(versao) {
  // Detectar a origem da página para construir a URL correta
  let baseUrl = '';
  {% if from_page == 'gestor' %}
    baseUrl = '{% url "gestor:ver_briefing" projeto_id=projeto.id %}';
  {% elif from_page == 'projetista' %}
    baseUrl = '{% url "projetista:ver_briefing" projeto_id=projeto.id %}';
  {% else %}
    // Fallback para URL genérica
    baseUrl = window.location.pathname.split('?')[0];
  {% endif %}
  
  // Adicionar parâmetro de versão e redirecionar
  window.location.href = baseUrl + '?versao=' + versao;
}
</script>