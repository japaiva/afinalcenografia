{% extends 'cliente/base_cliente.html' %}
{% load formatadores %}

{% block title %}{% if form.instance.pk %}Editar{% else %}Novo{% endif %} Projeto{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8 col-lg-6">
    <div class="card shadow">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0">{% if form.instance.pk %}Editar{% else %}Novo{% endif %} Projeto</h5>
      </div>
      
      <div class="card-body">
        <!-- Mantenha o enctype original caso a view esteja esperando isso -->
        <form method="post" {% if form.is_multipart %}enctype="multipart/form-data"{% endif %} class="row g-3" id="projetoForm">
          {% csrf_token %}
          
          <!-- Número do Projeto (apenas para edição) -->
          {% if form.instance.pk %}
          <div class="col-12">
            <label class="form-label">Número do Projeto</label>
            <input type="text" class="form-control" value="{{ form.instance.numero }}" readonly>
          </div>
          {% endif %}
          
          <!-- Feira - Campo obrigatório -->
          <div class="col-12">
            <label for="{{ form.feira.id_for_label }}" class="form-label">Feira*</label>
            {{ form.feira }}
            {% if form.feira.errors %}
              <div class="text-danger small">{{ form.feira.errors.0 }}</div>
            {% endif %}
            <div class="form-text">Selecione a feira associada a este projeto.</div>
          </div>
          
          <!-- Orçamento -->
          <div class="col-12">
            <label for="{{ form.orcamento.id_for_label }}" class="form-label">Orçamento (R$)*</label>
            {{ form.orcamento }}
            {% if form.orcamento.errors %}
              <div class="text-danger small">{{ form.orcamento.errors.0 }}</div>
            {% endif %}
          </div>
          
          <!-- Objetivo (em vez de Descrição) -->
          <div class="col-12">
            <label for="{{ form.descricao.id_for_label }}" class="form-label">Objetivo*</label>
            {{ form.descricao }}
            {% if form.descricao.errors %}
              <div class="text-danger small">{{ form.descricao.errors.0 }}</div>
            {% endif %}
          </div>
          
          <!-- Status (apenas mostrar, não editável) -->
          {% if form.instance.pk %}
          <div class="col-12">
            <label class="form-label">Status</label>
            <input type="text" class="form-control" value="{{ form.instance.get_status_display }}" readonly>
            <!-- Campo original escondido para manter o valor -->
            <div style="display:none;">{{ form.status }}</div>
          </div>
          {% else %}
          <!-- Use o próprio campo status mas escondido -->
          <div style="display:none;">{{ form.status }}</div>
          {% endif %}
          
          <!-- Campo nome escondido para validação (será preenchido com nome da feira) -->
          <div style="display:none;">{{ form.nome }}</div>
          
          <!-- Campos não exibidos mas mantidos para evitar erros de validação -->
          {% for field in form %}
            {% if field.name != 'nome' and field.name != 'feira' and field.name != 'orcamento' and field.name != 'descricao' and field.name != 'status' %}
              <div style="display:none;">{{ field }}</div>
            {% endif %}
          {% endfor %}
          
          <!-- Botões -->
          <div class="col-12 d-flex justify-content-between mt-4">
            <a href="{% url 'cliente:projeto_list' %}" class="btn btn-outline-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- AutoNumeric + lógica existente -->
<script src="https://cdn.jsdelivr.net/npm/autonumeric@4.6.0"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('projetoForm');

  // Definir valor padrão para status se for um novo projeto
  {% if not form.instance.pk %}
  const statusField = form.querySelector('[name="status"]');
  if (statusField) {
    statusField.value = 'briefing_pendente';  // Alterado para o novo status padrão
  }
  
  // Preencher automaticamente o nome com base na feira selecionada
  const feiraField = form.querySelector('[name="feira"]');
  const nomeField = form.querySelector('[name="nome"]');
  
  if (feiraField && nomeField) {
    // Inicialmente, preencher com a feira já selecionada
    if (feiraField.value) {
      const feiraOption = feiraField.options[feiraField.selectedIndex];
      nomeField.value = feiraOption.text;
    }
    
    // Atualizar quando a feira for alterada
    feiraField.addEventListener('change', function() {
      if (this.value) {
        const feiraOption = this.options[this.selectedIndex];
        nomeField.value = feiraOption.text;
      } else {
        nomeField.value = '';
      }
    });
  }
  {% endif %}

  // Previne múltiplos envios
  form.addEventListener('submit', function(event) {
    // Verificar se todos os campos obrigatórios estão preenchidos
    const feira = form.querySelector('[name="feira"]').value;
    const orcamento = form.querySelector('[name="orcamento"]').value;
    const objetivo = form.querySelector('[name="descricao"]').value;
    
    if (!feira || !orcamento || !objetivo) {
      event.preventDefault();
      alert('Por favor, preencha todos os campos obrigatórios.');
      return false;
    }
    
    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.innerHTML = 'Processando...';
  });

  // Máscara BRL no campo orçamento
  const campoOrcamento = document.getElementById('id_orcamento');
  if (campoOrcamento) {
    new AutoNumeric(campoOrcamento, {
      currencySymbol: 'R$ ',
      decimalCharacter: ',',
      digitGroupSeparator: '.',
      decimalPlaces: 2,
      unformatOnSubmit: true
    });
  }
  
  // Formatar campos de data
  const camposData = document.querySelectorAll('input[type="datetime-local"]');
  camposData.forEach(function(campo) {
    if (campo.value && !campo.value.includes('T')) {
      // Formatar data armazenada para formato datetime-local
      const data = new Date(campo.value);
      const ano = data.getFullYear();
      const mes = String(data.getMonth() + 1).padStart(2, '0');
      const dia = String(data.getDate()).padStart(2, '0');
      const hora = String(data.getHours()).padStart(2, '0');
      const minuto = String(data.getMinutes()).padStart(2, '0');
      
      campo.value = `${ano}-${mes}-${dia}T${hora}:${minuto}`;
    }
  });
});
</script>
{% endblock %}