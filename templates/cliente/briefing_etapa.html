{% extends 'cliente/base_cliente.html' %}
{% load static %}

{% block title %}Briefing: {{ titulo_etapa }} | {{ projeto.nome }} | Portal do Cliente{% endblock %}

{% block content %}
<div class="card shadow">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="fas fa-clipboard-list me-2"></i> Briefing de Projeto: {{ projeto.nome }}
    </h5>
    <div class="d-flex align-items-center">
      <!-- Status de Validação condensado no header -->
      <div class="me-3">
        <div class="d-flex align-items-center">
          {% for validacao in validacoes %}
            <div class="me-1" title="{{ validacao.get_secao_display }}: {{ validacao.get_status_display }}">
              <i class="fas 
                {% if validacao.status == 'aprovado' %}fa-check-circle text-success
                {% elif validacao.status == 'atencao' %}fa-exclamation-circle text-warning
                {% elif validacao.status == 'reprovado' %}fa-times-circle text-danger
                {% else %}fa-times-circle text-muted{% endif %} me-1"></i>
            </div>
          {% endfor %}
        </div>
      </div>
      
      <!-- Botões de ação -->
      <a href="{% url 'cliente:projeto_detail' pk=projeto.id %}" class="btn btn-outline-secondary btn-sm me-1">
        <i class="fas fa-project-diagram me-1"></i> Acessar Projeto
      </a>
      {% if todas_aprovadas %}
      <a href="{% url 'cliente:concluir_briefing' projeto_id=projeto.id %}" class="btn btn-primary btn-sm">
        <i class="fas fa-paper-plane me-1"></i> Enviar Briefing
      </a>
      {% else %}
      <button id="validarBriefing" class="btn btn-outline-primary btn-sm" data-url="{% url 'cliente:validar_briefing' projeto_id=projeto.id %}">
        <i class="fas fa-check-double me-1"></i> Validar Briefing
      </button>
      {% endif %}
    </div>
  </div>
  
  <div class="card-body p-0">
    <div class="row g-0">
      <!-- Formulário de Briefing -->
      <div class="col-lg-8 border-end">
        <div class="p-4">
          <div class="progress mb-4" style="height: 8px;">
            <div class="progress-bar bg-success" role="progressbar" style="width: {{ briefing.progresso }}%;" aria-valuenow="{{ briefing.progresso }}" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          
          <div class="d-flex justify-content-between mb-4">
            <div class="d-flex">
              {% if pode_voltar %}
              <a href="{% url 'cliente:briefing_etapa' projeto_id=projeto.id etapa=etapa|add:'-1' %}" class="btn btn-sm btn-outline-secondary me-2">
                <i class="fas fa-chevron-left me-1"></i> Anterior
              </a>
              {% else %}
              <button class="btn btn-sm btn-outline-secondary me-2" disabled>
                <i class="fas fa-chevron-left me-1"></i> Anterior
              </button>
              {% endif %}
              
              {% if pode_avancar %}
              <button type="submit" form="briefingForm" name="avancar" value="1" class="btn btn-sm btn-outline-primary">
                Próximo <i class="fas fa-chevron-right ms-1"></i>
              </button>
              {% else %}
              <button type="submit" form="briefingForm" name="concluir" value="1" class="btn btn-sm btn-success">
                Concluir <i class="fas fa-check ms-1"></i>
              </button>
              {% endif %}
            </div>
            <div class="text-muted">
              Etapa {{ etapa }} de 4
            </div>
          </div>
          
          <h4 class="mb-3">{{ titulo_etapa }}</h4>
          
          <!-- Informações da Feira (se existir) -->
          {% if projeto.feira and etapa == 1 %}
          <div class="alert alert-info mb-4">
            <div class="d-flex">
              <div class="me-3">
                <i class="fas fa-calendar-alt fa-2x text-primary"></i>
              </div>
              <div>
                <h5 class="alert-heading">Feira: {{ projeto.feira.nome }}</h5>
                <p class="mb-1">Local: {{ projeto.feira.local }}, {{ projeto.feira.cidade }}/{{ projeto.feira.estado }}</p>
                <p class="mb-1">Período: {{ projeto.feira.data_inicio|date:"d/m/Y" }} a {{ projeto.feira.data_fim|date:"d/m/Y" }}</p>
                {% if projeto.feira.manual %}
                <div class="mt-2">
                  <a href="{{ projeto.feira.manual.url }}" class="btn btn-outline-primary btn-sm" target="_blank">
                    <i class="fas fa-file-pdf me-1"></i> Manual da Feira
                  </a>
                  <button class="btn btn-outline-info btn-sm ms-1" data-bs-toggle="modal" data-bs-target="#feiraModal">
                    <i class="fas fa-question-circle me-1"></i> Perguntar sobre a Feira
                  </button>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}
          
          <!-- Formulário principal do briefing -->
          <form id="briefingForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
              <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                  <p class="mb-0">{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
            
            {% if etapa == 1 %}
            <!-- ETAPA 1: EVENTO - Datas e Localização -->
            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Informações do Evento</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12 mb-3">
                    <label for="{{ form.local_evento.id_for_label }}" class="form-label">
                      Local do Evento
                      {% if form.local_evento.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.local_evento }}
                      <span class="input-group-text 
                        {% if form.local_evento.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.local_evento.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.local_evento.help_text %}
                      <div class="form-text text-muted">{{ form.local_evento.help_text }}</div>
                    {% endif %}
                    {% if form.local_evento.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.local_evento.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.data_feira_inicio.id_for_label }}" class="form-label">
                      Data Início da Feira
                      {% if form.data_feira_inicio.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.data_feira_inicio }}
                      <span class="input-group-text 
                        {% if form.data_feira_inicio.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.data_feira_inicio.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.data_feira_inicio.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.data_feira_inicio.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.data_feira_fim.id_for_label }}" class="form-label">
                      Data Término da Feira
                      {% if form.data_feira_fim.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.data_feira_fim }}
                      <span class="input-group-text 
                        {% if form.data_feira_fim.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.data_feira_fim.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.data_feira_fim.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.data_feira_fim.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-12 mb-3">
                    <label for="{{ form.horario_feira.id_for_label }}" class="form-label">
                      Horário da Feira
                      {% if form.horario_feira.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.horario_feira }}
                      <span class="input-group-text 
                        {% if form.horario_feira.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.horario_feira.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.horario_feira.help_text %}
                      <div class="form-text text-muted">{{ form.horario_feira.help_text }}</div>
                    {% endif %}
                    {% if form.horario_feira.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.horario_feira.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Informações de Montagem e Desmontagem</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.data_montagem_inicio.id_for_label }}" class="form-label">
                      Início da Montagem
                      {% if form.data_montagem_inicio.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.data_montagem_inicio }}
                      <span class="input-group-text 
                        {% if form.data_montagem_inicio.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.data_montagem_inicio.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.data_montagem_inicio.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.data_montagem_inicio.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.data_montagem_fim.id_for_label }}" class="form-label">
                      Término da Montagem
                      {% if form.data_montagem_fim.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.data_montagem_fim }}
                      <span class="input-group-text 
                        {% if form.data_montagem_fim.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.data_montagem_fim.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.data_montagem_fim.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.data_montagem_fim.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.data_desmontagem_inicio.id_for_label }}" class="form-label">
                      Início da Desmontagem
                      {% if form.data_desmontagem_inicio.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.data_desmontagem_inicio }}
                      <span class="input-group-text 
                        {% if form.data_desmontagem_inicio.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.data_desmontagem_inicio.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.data_desmontagem_inicio.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.data_desmontagem_inicio.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.data_desmontagem_fim.id_for_label }}" class="form-label">
                      Término da Desmontagem
                      {% if form.data_desmontagem_fim.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.data_desmontagem_fim }}
                      <span class="input-group-text 
                        {% if form.data_desmontagem_fim.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.data_desmontagem_fim.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.data_desmontagem_fim.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.data_desmontagem_fim.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Localização do Estande</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12 mb-3">
                    <label for="{{ form.endereco_estande.id_for_label }}" class="form-label">
                      Endereço do Estande
                      {% if form.endereco_estande.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.endereco_estande }}
                      <span class="input-group-text 
                        {% if form.endereco_estande.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.endereco_estande.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.endereco_estande.help_text %}
                      <div class="form-text text-muted">{{ form.endereco_estande.help_text }}</div>
                    {% endif %}
                    {% if form.endereco_estande.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.endereco_estande.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            

            {% elif etapa == 2 %}
            <!-- ETAPA 2: ESTANDE - Características Físicas -->
            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Informações do Estande</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.area_estande.id_for_label }}" class="form-label">
                      Área do Estande (m²)
                      {% if form.area_estande.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.area_estande }}
                      <span class="input-group-text 
                        {% if form.area_estande.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.area_estande.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.area_estande.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.area_estande.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.estilo_estande.id_for_label }}" class="form-label">
                      Estilo do Estande
                      {% if form.estilo_estande.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.estilo_estande }}
                      <span class="input-group-text 
                        {% if form.estilo_estande.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.estilo_estande.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.estilo_estande.help_text %}
                      <div class="form-text text-muted">{{ form.estilo_estande.help_text }}</div>
                    {% endif %}
                    {% if form.estilo_estande.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.estilo_estande.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-12 mb-3">
                    <label for="{{ form.cores.id_for_label }}" class="form-label">
                      Cores
                      {% if form.cores.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.cores }}
                      <span class="input-group-text 
                        {% if form.cores.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.cores.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.cores.help_text %}
                      <div class="form-text text-muted">{{ form.cores.help_text }}</div>
                    {% endif %}
                    {% if form.cores.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.cores.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-12 mb-3">
                    <label for="{{ form.material.id_for_label }}" class="form-label">
                      Materiais
                      {% if form.material.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.material }}
                      <span class="input-group-text 
                        {% if form.material.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.material.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.material.help_text %}
                      <div class="form-text text-muted">{{ form.material.help_text }}</div>
                    {% endif %}
                    {% if form.material.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.material.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Estrutura do Estande</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.piso_elevado.id_for_label }}" class="form-label">
                      Piso Elevado
                      {% if form.piso_elevado.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.piso_elevado }}
                      <span class="input-group-text 
                        {% if form.piso_elevado.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.piso_elevado.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.piso_elevado.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.piso_elevado.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.tipo_testeira.id_for_label }}" class="form-label">
                      Tipo de Testeira
                      {% if form.tipo_testeira.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.tipo_testeira }}
                      <span class="input-group-text 
                        {% if form.tipo_testeira.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.tipo_testeira.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.tipo_testeira.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.tipo_testeira.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Funcionalidades do Estande</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <div class="form-check">
                      {{ form.havera_venda }}
                      <label class="form-check-label" for="{{ form.havera_venda.id_for_label }}">
                        Haverá venda no estande?
                      </label>
                    </div>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <div class="form-check">
                      {{ form.havera_ativacao }}
                      <label class="form-check-label" for="{{ form.havera_ativacao.id_for_label }}">
                        Haverá ativação no estande?
                      </label>
                    </div>
                  </div>
                  
                  <div class="col-md-12 mb-3">
                    <label for="{{ form.observacoes_estande.id_for_label }}" class="form-label">
                      Observações do Estande
                      {% if form.observacoes_estande.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <div class="input-group">
                      {{ form.observacoes_estande }}
                      <span class="input-group-text 
                        {% if form.observacoes_estande.value %}
                          {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                        {% endif %}">
                        <i class="fas 
                          {% if form.observacoes_estande.value %}
                            {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                          {% else %}fa-times-circle text-muted{% endif %}"></i>
                      </span>
                    </div>
                    {% if form.observacoes_estande.help_text %}
                      <div class="form-text text-muted">{{ form.observacoes_estande.help_text }}</div>
                    {% endif %}
                    {% if form.observacoes_estande.errors %}
                      <div class="form-text text-danger">
                        {% for error in form.observacoes_estande.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
            
                  <div class="col-md-12 mb-3">
                    <label class="form-label">Planta Baixa do Estande</label>
                    <div class="input-group" id="uploadForm">
                      <input type="file" class="form-control" id="arquivo" name="arquivo">
                      <input type="hidden" id="tipo" name="tipo" value="planta">
                      <button class="btn btn-outline-primary" type="button" id="uploadButton" data-url="{% url 'cliente:upload_arquivo_referencia' projeto_id=projeto.id %}">
                        <i class="fas fa-upload"></i>
                      </button>
                    </div>
                    <div class="form-text text-muted">Faça upload da planta baixa do estande, se disponível.</div>
                  </div>
                </div>
              </div>
            </div>
      
        {% elif etapa == 3 %}
        <!-- ETAPA 3: ÁREAS DO ESTANDE - Divisões Funcionais -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Área Aberta</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="{{ form.area_aberta_tamanho.id_for_label }}" class="form-label">
                  Metragem Área Aberta (m²)
                  {% if form.area_aberta_tamanho.field.required %}<span class="text-danger">*</span>{% endif %}
                </label>
                <div class="input-group">
                  {{ form.area_aberta_tamanho }}
                  <span class="input-group-text 
                    {% if form.area_aberta_tamanho.value %}
                      {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                    {% endif %}">
                    <i class="fas 
                      {% if form.area_aberta_tamanho.value %}
                        {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                      {% else %}fa-times-circle text-muted{% endif %}"></i>
                  </span>
                </div>
                {% if form.area_aberta_tamanho.errors %}
                  <div class="form-text text-danger">
                    {% for error in form.area_aberta_tamanho.errors %}
                      {{ error }}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <div class="col-md-6 mb-3 d-flex align-items-center">
                <div class="form-check">
                  {{ form.tem_mesas_atendimento }}
                  <label class="form-check-label" for="{{ form.tem_mesas_atendimento.id_for_label }}">
                    Mesas de Atendimento
                  </label>
                </div>
              </div>
              
              <div class="col-md-6 mb-3" id="qtd_mesas_div" style="display: none;">
                <label for="{{ form.qtd_mesas_atendimento.id_for_label }}" class="form-label">Quantidade de Mesas</label>
                {{ form.qtd_mesas_atendimento }}
              </div>
              
              <!-- Outras opções com checkboxes -->
              <div class="col-md-6 mb-3 d-flex align-items-center">
                <div class="form-check">
                  {{ form.tem_lounge }}
                  <label class="form-check-label" for="{{ form.tem_lounge.id_for_label }}">
                    Lounge
                  </label>
                </div>
              </div>
              
              <div class="col-md-6 mb-3 d-flex align-items-center">
                <div class="form-check">
                  {{ form.tem_balcao_cafe }}
                  <label class="form-check-label" for="{{ form.tem_balcao_cafe.id_for_label }}">
                    Balcão para Café/Bar
                  </label>
                </div>
              </div>
              
              <div class="col-md-6 mb-3 d-flex align-items-center">
                <div class="form-check">
                  {{ form.tem_vitrine }}
                  <label class="form-check-label" for="{{ form.tem_vitrine.id_for_label }}">
                    Vitrine para Exposição
                  </label>
                </div>
              </div>
              
              <div class="col-md-6 mb-3 d-flex align-items-center">
                <div class="form-check">
                  {{ form.tem_balcao_vitrine }}
                  <label class="form-check-label" for="{{ form.tem_balcao_vitrine.id_for_label }}">
                    Balcão Vitrine
                  </label>
                </div>
              </div>
              
              <div class="col-md-6 mb-3 d-flex align-items-center">
                <div class="form-check">
                  {{ form.tem_balcao_recepcao }}
                  <label class="form-check-label" for="{{ form.tem_balcao_recepcao.id_for_label }}">
                    Balcão Recepção
                  </label>
                </div>
              </div>
              
              <div class="col-md-6 mb-3 d-flex align-items-center">
                <div class="form-check">
                  {{ form.tem_caixa }}
                  <label class="form-check-label" for="{{ form.tem_caixa.id_for_label }}">
                    Caixa para Vendas
                  </label>
                </div>
              </div>
              
              <div class="col-12 mb-3">
                <label for="{{ form.equipamentos.id_for_label }}" class="form-label">Equipamentos</label>
                {{ form.equipamentos }}
                <div class="form-text">Painel de LED, TV, etc.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sala de Reunião -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Sala de Reunião</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3 d-flex align-items-center">
                <div class="form-check">
                  {{ form.tem_sala_reuniao }}
                  <label class="form-check-label" for="{{ form.tem_sala_reuniao.id_for_label }}">
                    Incluir Sala de Reunião
                  </label>
                </div>
              </div>
              
              <div class="col-md-6 mb-3" id="sala_capacidade_div" style="display: none;">
                <label for="{{ form.sala_reuniao_capacidade.id_for_label }}" class="form-label">Capacidade (pessoas)</label>
                {{ form.sala_reuniao_capacidade }}
              </div>
              
              <div class="col-md-6 mb-3" id="sala_tamanho_div" style="display: none;">
                <label for="{{ form.sala_reuniao_tamanho.id_for_label }}" class="form-label">Metragem (m²)</label>
                {{ form.sala_reuniao_tamanho }}
              </div>
              
              <div class="col-12 mb-3" id="sala_equipamentos_div" style="display: none;">
                <label for="{{ form.sala_reuniao_equipamentos.id_for_label }}" class="form-label">Equipamentos da Sala</label>
                {{ form.sala_reuniao_equipamentos }}
                <div class="form-text">Prateleira, TV, Armário, etc.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Copa -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Copa</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3 d-flex align-items-center">
                <div class="form-check">
                  {{ form.tem_copa }}
                  <label class="form-check-label" for="{{ form.tem_copa.id_for_label }}">
                    Incluir Copa
                  </label>
                </div>
              </div>
              
              <div class="col-md-6 mb-3" id="copa_tamanho_div" style="display: none;">
                <label for="{{ form.copa_tamanho.id_for_label }}" class="form-label">Metragem (m²)</label>
                {{ form.copa_tamanho }}
              </div>
              
              <div class="col-12 mb-3" id="copa_equipamentos_div" style="display: none;">
                <label for="{{ form.copa_equipamentos.id_for_label }}" class="form-label">Equipamentos da Copa</label>
                {{ form.copa_equipamentos }}
                <div class="form-text">Pia, geladeira, bancada, prateleiras, etc.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Depósito -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Depósito</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3 d-flex align-items-center">
                <div class="form-check">
                  {{ form.tem_deposito }}
                  <label class="form-check-label" for="{{ form.tem_deposito.id_for_label }}">
                    Incluir Depósito
                  </label>
                </div>
              </div>
              
              <div class="col-md-6 mb-3" id="deposito_tamanho_div" style="display: none;">
                <label for="{{ form.deposito_tamanho.id_for_label }}" class="form-label">Metragem (m²)</label>
                {{ form.deposito_tamanho }}
              </div>
              
              <div class="col-12 mb-3" id="deposito_equipamentos_div" style="display: none;">
                <label for="{{ form.deposito_equipamentos.id_for_label }}" class="form-label">Equipamentos do Depósito</label>
                {{ form.deposito_equipamentos }}
                <div class="form-text">Prateleiras, etc.</div>
              </div>
            </div>
          </div>
        </div>
        
        {% elif etapa == 4 %}
        <!-- ETAPA 4: DADOS COMPLEMENTARES - Referências Visuais -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Referências</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-12 mb-3">
                <label for="{{ form.referencias_dados.id_for_label }}" class="form-label">
                  Referências - Dados
                  {% if form.referencias_dados.field.required %}<span class="text-danger">*</span>{% endif %}
                </label>
                <div class="input-group">
                  {{ form.referencias_dados }}
                  <span class="input-group-text 
                    {% if form.referencias_dados.value %}
                      {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                    {% endif %}">
                    <i class="fas 
                      {% if form.referencias_dados.value %}
                        {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                      {% else %}fa-times-circle text-muted{% endif %}"></i>
                  </span>
                </div>
                {% if form.referencias_dados.help_text %}
                  <div class="form-text text-muted">{{ form.referencias_dados.help_text }}</div>
                {% endif %}
                {% if form.referencias_dados.errors %}
                  <div class="form-text text-danger">
                    {% for error in form.referencias_dados.errors %}
                      {{ error }}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <!-- Upload de arquivos de referência -->
              <div class="col-md-12 mb-3">
                <label class="form-label">Referências Visuais</label>
                <div class="input-group" id="uploadForm">
                  <input type="file" class="form-control" id="arquivo" name="arquivo">
                  <select class="form-select" id="tipo" name="tipo" style="max-width: 150px;">
                    <option value="referencia">Referência</option>
                    <option value="logo">Logo</option>
                    <option value="campanha">Campanha</option>
                    <option value="imagem">Imagem</option>
                  </select>
                  <button class="btn btn-outline-primary" type="button" id="uploadButton" data-url="{% url 'cliente:upload_arquivo_referencia' projeto_id=projeto.id %}">
                    <i class="fas fa-upload"></i>
                  </button>
                </div>
                <div class="form-text text-muted">Envie imagens de referência que possam ajudar a equipe a entender seu estilo desejado.</div>
                
                <div id="arquivosContainer" class="d-flex flex-wrap gap-2 mt-2">
                  {% for arquivo in arquivos %}
                  <div class="position-relative arquivo-item" data-id="{{ arquivo.id }}" style="width: 100px;">
                    {% if arquivo.tipo == 'imagem' or arquivo.tipo == 'referencia' or arquivo.tipo == 'logo' or arquivo.tipo == 'campanha' %}
                    <img src="{{ arquivo.arquivo.url }}" alt="{{ arquivo.nome }}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
                    {% else %}
                    <div class="bg-light border text-center p-2" style="width: 100px; height: 100px;">
                      <i class="fas 
                        {% if arquivo.tipo == 'planta' %}fa-map
                        {% elif arquivo.tipo == 'documento' %}fa-file-alt
                        {% else %}fa-file{% endif %} fa-3x my-2"></i>
                      <p class="small text-truncate mb-0">{{ arquivo.nome }}</p>
                    </div>
                    {% endif %}
                    <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 excluir-arquivo" style="font-size: 0.7rem; padding: 0.1rem 0.3rem;" data-url="{% url 'cliente:excluir_arquivo_referencia' arquivo_id=arquivo.id %}">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Logotipo e Campanha</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-12 mb-3">
                <label for="{{ form.logotipo.id_for_label }}" class="form-label">
                  Informações sobre o Logotipo
                  {% if form.logotipo.field.required %}<span class="text-danger">*</span>{% endif %}
                </label>
                <div class="input-group">
                  {{ form.logotipo }}
                  <span class="input-group-text 
                    {% if form.logotipo.value %}
                      {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                    {% endif %}">
                    <i class="fas 
                      {% if form.logotipo.value %}
                        {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                      {% else %}fa-times-circle text-muted{% endif %}"></i>
                  </span>
                </div>
                {% if form.logotipo.help_text %}
                  <div class="form-text text-muted">{{ form.logotipo.help_text }}</div>
                {% endif %}
                {% if form.logotipo.errors %}
                  <div class="form-text text-danger">
                    {% for error in form.logotipo.errors %}
                      {{ error }}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <div class="col-12 mb-3">
                <label for="{{ form.campanha_dados.id_for_label }}" class="form-label">
                  Campanha - Dados
                  {% if form.campanha_dados.field.required %}<span class="text-danger">*</span>{% endif %}
                </label>
                <div class="input-group">
                  {{ form.campanha_dados }}
                  <span class="input-group-text 
                    {% if form.campanha_dados.value %}
                      {% if validacao_atual.status == 'aprovado' %}bg-success{% else %}bg-warning{% endif %} text-white
                    {% endif %}">
                    <i class="fas 
                      {% if form.campanha_dados.value %}
                        {% if validacao_atual.status == 'aprovado' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}
                      {% else %}fa-times-circle text-muted{% endif %}"></i>
                  </span>
                </div>
                {% if form.campanha_dados.help_text %}
                  <div class="form-text text-muted">{{ form.campanha_dados.help_text }}</div>
                {% endif %}
                {% if form.campanha_dados.errors %}
                  <div class="form-text text-danger">
                    {% for error in form.campanha_dados.errors %}
                      {{ error }}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        </form>
      </div>
    </div>
    
    <!-- Assistente IA -->
    <div class="col-lg-4">
      <div class="p-3 h-100 d-flex flex-column">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">
            <i class="fas fa-robot me-2 text-primary"></i> Assistente IA
          </h5>
          <div class="d-flex">
            <button class="btn btn-sm btn-outline-primary me-1" id="novaPergunta" title="Fazer nova pergunta">
              <i class="fas fa-question-circle"></i>
            </button>
            {% if projeto.feira %}
            <button class="btn btn-sm btn-outline-info" id="perguntaFeira" title="Perguntar sobre a feira"
                    data-bs-toggle="modal" data-bs-target="#feiraModal">
              <i class="fas fa-calendar-alt"></i>
            </button>
            {% endif %}
          </div>
        </div>
        
        <!-- Input do chat (no topo) -->
        <div class="chat-input mb-3">
          <form id="chatForm" data-url="{% url 'cliente:enviar_mensagem_ia' projeto_id=projeto.id %}">
            <div class="input-group">
              <input type="text" class="form-control" id="mensagemInput" name="mensagem" placeholder="Faça uma pergunta ao assistente...">
              <button class="btn btn-primary" type="submit" id="enviarMensagem">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </form>
        </div>
        
        <!-- Chat da IA (abaixo do input) -->
        <div class="chat-container bg-light rounded p-3 flex-grow-1 overflow-auto" style="height: 400px;" id="chatContainer">
          {% for conversa in conversas %}
            <div class="chat-message {{ conversa.origem }}-message mb-3">
              <div class="chat-bubble">
                <p>{{ conversa.mensagem|linebreaks }}</p>
              </div>
              <small class="text-muted">{{ conversa.timestamp|time:"H:i" }}</small>
            </div>
          {% empty %}
            <div class="chat-message ai-message mb-3">
              <div class="chat-bubble">
                <p>Olá! Sou o assistente do briefing. Estou aqui para ajudá-lo a preencher todas as informações do seu projeto.</p>
                
                {% if etapa == 1 %}
                <p>Nesta etapa, precisamos das informações sobre o evento, datas de montagem e desmontagem, e localização do estande.</p>
                {% elif etapa == 2 %}
                <p>Nesta etapa, precisamos das características físicas do estande, como área, estilo, cores e materiais.</p>
                {% elif etapa == 3 %}
                <p>Nesta etapa, vamos definir as áreas funcionais do estande, como área aberta, sala de reunião, copa e depósito.</p>
                {% elif etapa == 4 %}
                <p>Nesta etapa final, adicione referências visuais, informações sobre logotipo e campanha para guiar o projeto.</p>
                {% endif %}
                
                {% if projeto.feira %}
                <p>Observei que este projeto está associado à feira <strong>{{ projeto.feira.nome }}</strong>. Eu posso ajudar com dúvidas específicas sobre as regras e requisitos desta feira. Clique no botão <i class="fas fa-calendar-alt"></i> acima para fazer perguntas sobre a feira.</p>
                {% endif %}
              </div>
              <small class="text-muted">Agora</small>
            </div>
          {% endfor %}
        </div>
        
        <!-- Status de Validação -->
        <div class="validation-status p-3 border-top mt-3">
          <h6 class="mb-3">Status de Validação</h6>
          <ul class="list-group list-group-flush">
            {% for validacao in validacoes %}
            <li class="list-group-item d-flex justify-content-between align-items-center px-0 border-0">
              <span>
                <i class="fas 
                  {% if validacao.status == 'aprovado' %}fa-check-circle text-success
                  {% elif validacao.status == 'atencao' %}fa-exclamation-circle text-warning
                  {% elif validacao.status == 'reprovado' %}fa-times-circle text-danger
                  {% else %}fa-times-circle text-muted{% endif %} me-2"></i>
                {{ validacao.get_secao_display }}
              </span>
              <span class="badge 
                {% if validacao.status == 'aprovado' %}bg-success
                {% elif validacao.status == 'atencao' %}bg-warning text-dark
                {% elif validacao.status == 'reprovado' %}bg-danger
                {% else %}bg-secondary{% endif %}">
                {{ validacao.get_status_display }}
              </span>
            </li>
            {% endfor %}
          </ul>
          <div class="text-center mt-3">
            <button class="btn btn-outline-primary btn-sm" id="revalidarBriefing" data-url="{% url 'cliente:validar_briefing' projeto_id=projeto.id %}">
              <i class="fas fa-sync-alt me-1"></i> Revalidar Briefing
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Modal para perguntas sobre a feira -->
{% if projeto.feira %}
<div class="modal fade" id="feiraModal" tabindex="-1" aria-labelledby="feiraModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="feiraModalLabel">
          <i class="fas fa-calendar-alt me-2"></i> Perguntar sobre a Feira
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form id="feiraForm" action="{% url 'cliente:briefing_perguntar_feira' briefing_id=briefing.id %}" method="post">
          {% csrf_token %}
          <div class="mb-3">
            <label for="perguntaFeira" class="form-label">O que você gostaria de saber sobre a feira "{{ projeto.feira.nome }}"?</label>
            <textarea class="form-control" id="perguntaFeiraTexto" name="pergunta" rows="3" placeholder="Ex: Quais são as limitações de altura para o estande? Preciso de alguma autorização especial?"></textarea>
            <div class="form-text">
              <i class="fas fa-info-circle me-1"></i> O assistente irá consultar o manual da feira para responder sua pergunta.
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" form="feiraForm" class="btn btn-primary">
          <i class="fas fa-paper-plane me-1"></i> Enviar Pergunta
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<style>
.chat-container {
  display: flex;
  flex-direction: column;
}

.chat-message {
  max-width: 85%;
  margin-bottom: 15px;
  display: flex;
  flex-direction: column;
}

.ai-message {
  align-self: flex-start;
}

.cliente-message {
  align-self: flex-end;
  text-align: right;
}

.chat-bubble {
  padding: 10px 15px;
  border-radius: 18px;
  position: relative;
  display: inline-block;
  max-width: 100%;
}

.ai-message .chat-bubble {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  border-bottom-left-radius: 5px;
  text-align: left;
}

.cliente-message .chat-bubble {
  background-color: #e9f3ff;
  border: 1px solid #cce5ff;
  border-bottom-right-radius: 5px;
  text-align: left;
}

.chat-message small {
  margin-top: 5px;
  font-size: 0.7rem;
}
</style>

{% block extra_js %}
<script>
$(document).ready(function() {
  // Auto-salvar o formulário quando houver mudanças
  let formChanged = false;
  
  $('#briefingForm input, #briefingForm textarea, #briefingForm select').on('change', function() {
    formChanged = true;
  });
  
  function autosave() {
    if (formChanged) {
      const formData = new FormData($('#briefingForm')[0]);
      
      $.ajax({
        url: "{% url 'cliente:salvar_rascunho_briefing' projeto_id=projeto.id %}",
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function() {
          // Salvamento silencioso, sem notificação para o usuário
          formChanged = false;
        }
      });
    }
  }
  
  // Salvar a cada 30 segundos se houver mudanças
  setInterval(autosave, 30000);
  
  // Salvar ao sair da página
  $(window).on('beforeunload', function() {
    if (formChanged) {
      autosave();
    }
  });
  
  // Mostrar/esconder campos baseados em checkboxes
  {% if etapa == 3 %}
  // Função para atualizar a visibilidade com base no estado dos checkboxes
  function updateVisibility() {
    // Área Aberta - Mesas
    const temMesasCheckbox = document.getElementById('{{ form.tem_mesas_atendimento.id_for_label }}');
    const qtdMesasDiv = document.getElementById('qtd_mesas_div');
    
    if (temMesasCheckbox && qtdMesasDiv) {
      qtdMesasDiv.style.display = temMesasCheckbox.checked ? 'block' : 'none';
      
      temMesasCheckbox.addEventListener('change', function() {
        qtdMesasDiv.style.display = this.checked ? 'block' : 'none';
      });
    }
    
    // Sala de Reunião
    const temSalaCheckbox = document.getElementById('{{ form.tem_sala_reuniao.id_for_label }}');
    const salaCapacidadeDiv = document.getElementById('sala_capacidade_div');
    const salaTamanhoDiv = document.getElementById('sala_tamanho_div');
    const salaEquipamentosDiv = document.getElementById('sala_equipamentos_div');
    
    if (temSalaCheckbox && salaCapacidadeDiv && salaTamanhoDiv && salaEquipamentosDiv) {
      const salaDivs = [salaCapacidadeDiv, salaTamanhoDiv, salaEquipamentosDiv];
      
      salaDivs.forEach(div => {
        div.style.display = temSalaCheckbox.checked ? 'block' : 'none';
      });
      
      temSalaCheckbox.addEventListener('change', function() {
        salaDivs.forEach(div => {
          div.style.display = this.checked ? 'block' : 'none';
        });
      });
    }
    
    // Copa
    const temCopaCheckbox = document.getElementById('{{ form.tem_copa.id_for_label }}');
    const copaTamanhoDiv = document.getElementById('copa_tamanho_div');
    const copaEquipamentosDiv = document.getElementById('copa_equipamentos_div');
    
    if (temCopaCheckbox && copaTamanhoDiv && copaEquipamentosDiv) {
      const copaDivs = [copaTamanhoDiv, copaEquipamentosDiv];
      
      copaDivs.forEach(div => {
        div.style.display = temCopaCheckbox.checked ? 'block' : 'none';
      });
      
      temCopaCheckbox.addEventListener('change', function() {
        copaDivs.forEach(div => {
          div.style.display = this.checked ? 'block' : 'none';
        });
      });
    }
    
    // Depósito
    const temDepositoCheckbox = document.getElementById('{{ form.tem_deposito.id_for_label }}');
    const depositoTamanhoDiv = document.getElementById('deposito_tamanho_div');
    const depositoEquipamentosDiv = document.getElementById('deposito_equipamentos_div');
    
    if (temDepositoCheckbox && depositoTamanhoDiv && depositoEquipamentosDiv) {
      const depositoDivs = [depositoTamanhoDiv, depositoEquipamentosDiv];
      
      depositoDivs.forEach(div => {
        div.style.display = temDepositoCheckbox.checked ? 'block' : 'none';
      });
      
      temDepositoCheckbox.addEventListener('change', function() {
        depositoDivs.forEach(div => {
          div.style.display = this.checked ? 'block' : 'none';
        });
      });
    }
  }
  
  // Inicializa a visibilidade dos campos
  {% if etapa == 3 %}
  updateVisibility();
  {% endif %}
  {% endif %}
  
  // Scroll para colocar as mensagens mais recentes no topo do chat
  const scrollChatToTop = () => {
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.scrollTop = 0;
  };

  scrollChatToTop();
  
  // Submit chat message
  $('#chatForm').on('submit', function(e) {
    e.preventDefault();
    
    const url = $(this).data('url');
    const mensagem = $('#mensagemInput').val();
    
    if (!mensagem.trim()) return;
    
    // Disable input while sending
    $('#mensagemInput').prop('disabled', true);
    $('#enviarMensagem').prop('disabled', true);
    
    // Add message to chat immediately
    const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    // Prepend message (add at the top) instead of append
    $('#chatContainer').prepend(`
      <div class="chat-message cliente-message mb-3">
        <div class="chat-bubble">
          <p>${mensagem}</p>
        </div>
        <small class="text-muted">${timestamp}</small>
      </div>
    `);
    
    scrollChatToTop();
    
    // Send to server
    $.ajax({
      url: url,
      type: 'POST',
      data: {
        mensagem: mensagem,
        etapa: {{ etapa }},
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function(response) {
        // Prepend AI response at the top
        $('#chatContainer').prepend(`
          <div class="chat-message ai-message mb-3">
            <div class="chat-bubble">
              <p>${response.mensagem_ia.texto.replace(/\n/g, '<br>')}</p>
            </div>
            <small class="text-muted">${response.mensagem_ia.timestamp}</small>
          </div>
        `);
        
        scrollChatToTop();
      },
      error: function(xhr, status, error) {
        alert('Erro ao enviar mensagem: ' + error);
      },
      complete: function() {
        // Clear and re-enable input
        $('#mensagemInput').val('').prop('disabled', false).focus();
        $('#enviarMensagem').prop('disabled', false);
      }
    });
  });
  
  // Handle file upload
  $('#uploadButton').on('click', function() {
    const url = $(this).data('url');
    const fileInput = $('#arquivo')[0];
    const tipoInput = $('#tipo').val();
    
    if (fileInput.files.length === 0) {
      alert('Selecione um arquivo para upload');
      return;
    }
    
    const formData = new FormData();
    formData.append('arquivo', fileInput.files[0]);
    formData.append('tipo', tipoInput);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    $.ajax({
      url: url,
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function(response) {
        // Add file to display
        const tipoIconClass = 
          response.arquivo.tipo === 'Imagem' || response.arquivo.tipo === 'Referência' || response.arquivo.tipo === 'Logo' || response.arquivo.tipo === 'Campanha' ? 'fa-image' :
          response.arquivo.tipo === 'Planta' ? 'fa-map' :
          response.arquivo.tipo === 'Documento' ? 'fa-file-alt' : 'fa-file';
        
        if (response.arquivo.tipo === 'Imagem' || response.arquivo.tipo === 'Referência' || response.arquivo.tipo === 'Logo' || response.arquivo.tipo === 'Campanha') {
          $('#arquivosContainer').append(`
            <div class="position-relative arquivo-item" data-id="${response.arquivo.id}" style="width: 100px;">
              <img src="${response.arquivo.url}" alt="${response.arquivo.nome}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
              <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 excluir-arquivo" style="font-size: 0.7rem; padding: 0.1rem 0.3rem;" data-url="{% url 'cliente:excluir_arquivo_referencia' arquivo_id=0 %}".replace('0', response.arquivo.id)>
                <i class="fas fa-times"></i>
              </button>
            </div>
          `);
        } else {
          $('#arquivosContainer').append(`
            <div class="position-relative arquivo-item" data-id="${response.arquivo.id}" style="width: 100px;">
              <div class="bg-light border text-center p-2" style="width: 100px; height: 100px;">
                <i class="fas ${tipoIconClass} fa-3x my-2"></i>
                <p class="small text-truncate mb-0">${response.arquivo.nome}</p>
              </div>
              <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 excluir-arquivo" style="font-size: 0.7rem; padding: 0.1rem 0.3rem;" data-url="{% url 'cliente:excluir_arquivo_referencia' arquivo_id=0 %}".replace('0', response.arquivo.id)>
                <i class="fas fa-times"></i>
              </button>
            </div>
          `);
        }
        
        // Clear file input
        fileInput.value = '';
      },
      error: function(xhr, status, error) {
        alert('Erro ao fazer upload: ' + error);
      }
    });
  });
  
  // Handle delete file
  $(document).on('click', '.excluir-arquivo', function() {
    const url = $(this).data('url');
    const arquivoItem = $(this).closest('.arquivo-item');
    
    if (confirm('Tem certeza que deseja excluir este arquivo?')) {
      $.ajax({
        url: url,
        type: 'POST',
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
          arquivoItem.remove();
        },
        error: function(xhr, status, error) {
          alert('Erro ao excluir arquivo: ' + error);
        }
      });
    }
  });
  
  // Validate briefing
  $('#validarBriefing, #revalidarBriefing').on('click', function() {
    const url = $(this).data('url');
    
    // Save form first
    autosave();
    
    // Disable button and show loading state
    const button = $(this);
    const originalText = button.html();
    button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Validando...');
    
    $.ajax({
      url: url,
      type: 'POST',
      data: {
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function(response) {
        // Refresh page to show updated validation status
        location.reload();
      },
      error: function(xhr, status, error) {
        alert('Erro ao validar briefing: ' + error);
        // Restore button state
        button.prop('disabled', false).html(originalText);
      }
    });
  });
  
  // Handle feira form submission
  $('#feiraForm').on('submit', function() {
    const pergunta = $('#perguntaFeiraTexto').val();
    if (!pergunta.trim()) {
      alert('Por favor, digite uma pergunta sobre a feira.');
      return false;
    }
    return true;
  });
});
</script>
{% endblock %}
{% endblock %}